<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DB Viewer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #333; display: flex; height: 100vh; }

        /* Sidebar - Airtable dark style */
        .sidebar { width: 260px; background: #1d1f25; border-right: 1px solid #2d2f36; overflow-y: auto; flex-shrink: 0; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid #2d2f36; }
        .sidebar-header h2 { color: #fff; font-size: 14px; font-weight: 600; }
        .sidebar div.table-item { padding: 8px 16px; cursor: pointer; font-size: 13px; color: #b3b3b3; display: flex; align-items: center; gap: 8px; }
        .sidebar div.table-item:hover { background: #2d2f36; color: #fff; }
        .sidebar div.table-item.active { background: #2d6cdf; color: #fff; }
        .sidebar div.table-item .count { margin-left: auto; font-size: 11px; color: #666; }
        .sidebar div.table-item.active .count { color: rgba(255,255,255,0.7); }
        .table-icon { width: 16px; height: 16px; background: #2d6cdf; border-radius: 3px; flex-shrink: 0; }

        /* Table item with expandable views */
        .sidebar div.table-item { position: relative; }
        .sidebar div.table-item .expand-arrow {
            margin-left: auto;
            font-size: 10px;
            color: #666;
            transition: transform 0.2s;
            padding: 4px;
        }
        .sidebar div.table-item.expanded .expand-arrow { transform: rotate(90deg); }
        .sidebar div.table-item .count { margin-left: 8px; }

        /* Table views list (expandable) */
        .table-views-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
            background: #16181d;
        }
        .table-views-list.expanded {
            max-height: 500px;
        }
        .table-view-item {
            padding: 6px 16px 6px 44px;
            cursor: pointer;
            font-size: 12px;
            color: #8a8a8a;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }
        .table-view-item:hover {
            background: #2d2f36;
            color: #fff;
        }
        .table-view-item.active {
            background: #1e4fa8;
            color: #fff;
        }
        .table-view-item .view-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
            color: #666;
        }
        .table-view-item:hover .view-icon,
        .table-view-item.active .view-icon {
            color: inherit;
        }
        .table-view-item .view-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table-view-default {
            color: #666;
            font-style: italic;
        }

        /* Main content - Airtable light style */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; }

        /* Toolbar */
        .toolbar { padding: 12px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; background: #fff; }
        .toolbar h1 { font-size: 18px; font-weight: 600; color: #333; flex: 1; }
        .btn { padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; color: #333; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .btn:hover { background: #e8e8e8; }
        .btn-primary { background: #2d6cdf; border-color: #2d6cdf; color: #fff; }
        .btn-primary:hover { background: #2560c9; }

        /* Status bar */
        .status-bar { padding: 8px 20px; background: #fafafa; border-bottom: 1px solid #e0e0e0; font-size: 12px; color: #666; display: flex; align-items: center; gap: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.synced { background: #20c933; }
        .status-dot.loading { background: #fcb400; }

        /* Table container */
        .table-container { flex: 1; overflow: auto; }

        /* Airtable-style table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f5f5f5; border-bottom: 2px solid #ddd; padding: 8px 12px; text-align: left; font-weight: 500; color: #333; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        th:first-child { width: 120px; color: #666; }
        td { border-bottom: 1px solid #eee; padding: 8px 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: top; }
        tr:hover td { background: #f8f9fa; }
        tr.selected td { background: #e8f0fe; }

        /* Cell content styling */
        .cell-empty { color: #ccc; }
        .cell-array { color: #333; }
        .cell-array .tag { display: inline-block; background: #e8f0fe; color: #2d6cdf; padding: 2px 8px; border-radius: 12px; margin: 1px 2px 1px 0; font-size: 12px; }
        .cell-link { color: #2d6cdf; text-decoration: none; }
        .cell-link:hover { text-decoration: underline; }
        .cell-number { font-family: "SF Mono", Monaco, monospace; }
        .cell-bool { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .cell-bool.true { background: #d4edda; color: #155724; }
        .cell-bool.false { background: #f8d7da; color: #721c24; }

        /* Pagination */
        .pagination { padding: 12px 20px; border-top: 1px solid #e0e0e0; background: #fafafa; display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .pagination button { padding: 6px 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .pagination button:hover:not(:disabled) { background: #f5f5f5; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination .page-info { color: #666; }

        /* Auth screen */
        #auth-screen { position: fixed; inset: 0; background: #1d1f25; display: flex; align-items: center; justify-content: center; z-index: 100; }
        .auth-box { background: #fff; border-radius: 8px; padding: 32px; width: 360px; box-shadow: 0 4px 24px rgba(0,0,0,0.3); }
        .auth-box h2 { font-size: 20px; margin-bottom: 8px; color: #333; }
        .auth-box p { font-size: 13px; color: #666; margin-bottom: 24px; }
        .auth-box input { width: 100%; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; color: #333; font-size: 14px; margin-bottom: 12px; }
        .auth-box input:focus { outline: none; border-color: #2d6cdf; box-shadow: 0 0 0 3px rgba(45,108,223,0.1); }
        .auth-box button { width: 100%; padding: 10px; background: #2d6cdf; border: none; border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer; margin-bottom: 8px; font-weight: 500; }
        .auth-box button:hover { background: #2560c9; }
        .auth-box button:disabled { background: #ccc; cursor: not-allowed; }
        .auth-box button.secondary { background: #f5f5f5; color: #333; }
        .auth-box button.secondary:hover { background: #e8e8e8; }
        .auth-error { color: #dc3545; font-size: 13px; margin-bottom: 12px; padding: 8px 12px; background: #f8d7da; border-radius: 4px; display: none; }
        .auth-info { color: #666; font-size: 12px; margin-top: 16px; text-align: center; }
        .hidden { display: none !important; }

        /* Empty state */
        .empty-state { padding: 60px 20px; text-align: center; color: #666; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: #333; }

        /* Loading states */
        .loading-state { padding: 60px 20px; text-align: center; color: #666; }
        .loading-state h3 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #e0e0e0; border-top-color: #2d6cdf; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Skeleton loading for table */
        .skeleton-row td { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-cell { height: 16px; background: #e0e0e0; border-radius: 4px; }

        /* Progress bar */
        .progress-bar { height: 3px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; background: #2d6cdf; transition: width 0.3s ease; }

        /* Table loading indicator */
        .table-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .table-container { position: relative; }

        /* Airtable-style View Controls Bar */
        .view-controls-bar { display: flex; align-items: center; gap: 4px; padding: 8px 20px; background: #fff; border-bottom: 1px solid #e0e0e0; }
        .view-control-wrapper { position: relative; }
        .view-control-btn { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: transparent; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: #555; transition: all 0.15s; }
        .view-control-btn:hover { background: #f0f0f0; color: #333; }
        .view-control-btn.active { background: #e8f0fe; color: #2d6cdf; }
        .view-control-btn svg { flex-shrink: 0; }
        .control-count { background: #2d6cdf; color: #fff; font-size: 10px; font-weight: 600; padding: 1px 5px; border-radius: 8px; min-width: 16px; text-align: center; }
        .view-controls-spacer { flex: 1; }

        /* View Search */
        .view-search-wrapper { position: relative; display: flex; align-items: center; }
        .view-search-wrapper .search-icon { position: absolute; left: 10px; color: #999; pointer-events: none; }
        .view-search-input { padding: 6px 10px 6px 32px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 180px; transition: all 0.15s; }
        .view-search-input:focus { outline: none; border-color: #2d6cdf; box-shadow: 0 0 0 2px rgba(45,108,223,0.1); width: 220px; }
        .view-search-input::placeholder { color: #aaa; }

        /* View Control Dropdowns */
        .view-control-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100; min-width: 280px; display: none; }
        .view-control-dropdown.open { display: block; }
        .dropdown-section { padding: 0; }
        .dropdown-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee; background: #fafafa; border-radius: 8px 8px 0 0; }
        .dropdown-header span { font-size: 13px; font-weight: 600; color: #333; }
        .dropdown-action-btn { background: transparent; border: none; color: #2d6cdf; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .dropdown-action-btn:hover { background: #e8f0fe; }

        /* Filter Dropdown */
        .filter-list { padding: 12px 16px; max-height: 300px; overflow-y: auto; }
        .empty-filters, .empty-sorts { color: #999; font-size: 13px; text-align: center; padding: 20px 0; }
        .filter-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .filter-row:last-child { border-bottom: none; }
        .filter-row select, .filter-row input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .filter-row select { min-width: 100px; }
        .filter-row input { flex: 1; min-width: 80px; }
        .filter-remove-btn { background: transparent; border: none; color: #999; cursor: pointer; padding: 4px; border-radius: 4px; }
        .filter-remove-btn:hover { background: #fee2e2; color: #dc2626; }

        /* Sort Dropdown */
        .sort-list { padding: 12px 16px; max-height: 300px; overflow-y: auto; }
        .sort-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .sort-row:last-child { border-bottom: none; }
        .sort-row select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; flex: 1; }
        .sort-direction-btns { display: flex; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .sort-direction-btn { padding: 6px 10px; background: #fff; border: none; cursor: pointer; font-size: 11px; color: #666; }
        .sort-direction-btn.active { background: #2d6cdf; color: #fff; }
        .sort-direction-btn:first-child { border-right: 1px solid #ddd; }
        .sort-remove-btn { background: transparent; border: none; color: #999; cursor: pointer; padding: 4px; border-radius: 4px; }
        .sort-remove-btn:hover { background: #fee2e2; color: #dc2626; }

        /* Group Dropdown */
        .group-options, .color-options { padding: 8px 0; }
        .group-option, .color-option { display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer; font-size: 13px; transition: background 0.1s; }
        .group-option:hover, .color-option:hover { background: #f5f5f5; }
        .group-option .check-mark, .color-option .check-mark { color: #2d6cdf; font-size: 14px; width: 16px; visibility: hidden; }
        .group-option.selected .check-mark, .color-option.selected .check-mark, .group-option.none-selected .check-mark, .color-option.none-selected .check-mark { visibility: visible; }

        /* Row Height Dropdown */
        .row-height-option { display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer; font-size: 13px; transition: background 0.1s; }
        .row-height-option:hover { background: #f5f5f5; }
        .row-height-option.selected { background: #e8f0fe; color: #2d6cdf; }
        .row-height-option svg { color: #666; }
        .row-height-option.selected svg { color: #2d6cdf; }

        /* Row height variations */
        table.row-height-short td { padding: 4px 12px; }
        table.row-height-medium td { padding: 8px 12px; }
        table.row-height-tall td { padding: 14px 12px; }
        table.row-height-extra-tall td { padding: 20px 12px; white-space: normal; }

        /* Field History Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal { background: #fff; border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); transform: translateY(20px); transition: transform 0.2s; }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; }
        .modal-header h2 { font-size: 18px; font-weight: 600; color: #333; flex: 1; margin: 0; }
        .modal-header .record-id { font-size: 12px; color: #999; font-family: "SF Mono", Monaco, monospace; }
        .modal-close { width: 32px; height: 32px; border: none; background: #f5f5f5; border-radius: 6px; cursor: pointer; font-size: 18px; color: #666; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: #e8e8e8; color: #333; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .modal-empty { padding: 60px 20px; text-align: center; color: #666; }
        .modal-empty h3 { font-size: 16px; color: #333; margin-bottom: 8px; }

        /* History Timeline */
        .history-timeline { padding: 16px 0; }
        .history-item { padding: 16px 24px; border-bottom: 1px solid #f0f0f0; transition: background 0.15s; }
        .history-item:hover { background: #fafafa; }
        .history-item:last-child { border-bottom: none; }
        .history-item-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .history-field-name { font-weight: 600; color: #333; font-size: 14px; }
        .history-change-type { font-size: 11px; font-weight: 500; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .history-change-type.created { background: #d1fae5; color: #059669; }
        .history-change-type.updated { background: #dbeafe; color: #1d4ed8; }
        .history-change-type.deleted { background: #fee2e2; color: #dc2626; }
        .history-timestamp { font-size: 12px; color: #999; margin-left: auto; }
        .history-event-id { font-size: 11px; color: #ccc; font-family: "SF Mono", Monaco, monospace; }
        .history-values { display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .history-value-box { flex: 1; min-width: 200px; padding: 10px 12px; border-radius: 6px; font-size: 13px; }
        .history-value-box.old { background: #fef2f2; border: 1px solid #fecaca; }
        .history-value-box.new { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .history-value-box.null { background: #f5f5f5; border: 1px solid #e0e0e0; color: #999; font-style: italic; }
        .history-value-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 4px; }
        .history-value-content { word-break: break-word; color: #333; }
        .history-arrow { color: #999; font-size: 16px; flex-shrink: 0; align-self: center; }

        /* History Button in Table */
        .history-btn { padding: 4px 8px; background: transparent; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; display: inline-flex; align-items: center; gap: 4px; transition: all 0.15s; }
        .history-btn:hover { background: #f5f5f5; border-color: #2d6cdf; color: #2d6cdf; }
        .history-btn svg { width: 12px; height: 12px; }

        /* Field filter in modal */
        .modal-toolbar { padding: 12px 24px; background: #fafafa; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; }
        .modal-toolbar select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: #fff; }
        .modal-toolbar .history-count { font-size: 12px; color: #666; margin-left: auto; }

        /* View Selector in Data Toolbar */
        .view-selector { position: relative; display: flex; align-items: center; gap: 8px; }
        .view-selector-btn { padding: 6px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; min-width: 140px; transition: border-color 0.15s; }
        .view-selector-btn:hover { border-color: #2d6cdf; }
        .view-selector-btn .view-icon { font-size: 14px; }
        .view-selector-btn .view-name { flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .view-selector-btn .dropdown-arrow { font-size: 10px; color: #666; }
        .view-selector-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; min-width: 200px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100; max-height: 300px; overflow-y: auto; display: none; }
        .view-selector-dropdown.open { display: block; }
        .view-selector-dropdown-header { padding: 10px 12px; font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee; background: #fafafa; }
        .view-selector-option { padding: 10px 12px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; transition: background 0.1s; }
        .view-selector-option:hover { background: #f5f5f5; }
        .view-selector-option.active { background: #e8f0fe; color: #2d6cdf; }
        .view-selector-option .view-type-icon { width: 20px; text-align: center; }
        .view-selector-option .view-option-name { flex: 1; }
        .view-selector-option .view-check { color: #2d6cdf; font-size: 14px; }

        /* Fields Button & Dropdown */
        .fields-btn { padding: 6px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .fields-btn:hover { border-color: #2d6cdf; background: #f8faff; }
        .fields-btn .fields-icon { font-size: 14px; }
        .fields-btn .fields-count { background: #e8f0fe; color: #2d6cdf; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .fields-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; width: 280px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100; display: none; }
        .fields-dropdown.open { display: block; }
        .fields-dropdown-header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .fields-dropdown-header h3 { font-size: 14px; font-weight: 600; color: #333; margin: 0; }
        .fields-dropdown-actions { display: flex; gap: 8px; }
        .fields-dropdown-actions button { padding: 4px 8px; font-size: 11px; background: transparent; border: none; color: #2d6cdf; cursor: pointer; border-radius: 4px; }
        .fields-dropdown-actions button:hover { background: #e8f0fe; }
        .fields-dropdown-list { max-height: 350px; overflow-y: auto; padding: 8px 0; }
        .fields-dropdown-item { padding: 8px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.1s; user-select: none; }
        .fields-dropdown-item:hover { background: #f5f5f5; }
        .fields-dropdown-item.dragging { background: #e8f0fe; opacity: 0.8; }
        .fields-dropdown-item .field-drag-handle { cursor: grab; color: #ccc; font-size: 12px; padding: 2px; }
        .fields-dropdown-item .field-drag-handle:hover { color: #999; }
        .fields-dropdown-item .field-checkbox { width: 18px; height: 18px; border: 2px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
        .fields-dropdown-item .field-checkbox.checked { background: #2d6cdf; border-color: #2d6cdf; color: #fff; }
        .fields-dropdown-item .field-checkbox .check-icon { font-size: 12px; display: none; }
        .fields-dropdown-item .field-checkbox.checked .check-icon { display: block; }
        .fields-dropdown-item .field-info { flex: 1; min-width: 0; }
        .fields-dropdown-item .field-name { font-size: 13px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .fields-dropdown-item .field-type { font-size: 11px; color: #999; }
        .fields-dropdown-item .field-move-btns { display: flex; flex-direction: column; gap: 2px; opacity: 0; transition: opacity 0.15s; }
        .fields-dropdown-item:hover .field-move-btns { opacity: 1; }
        .fields-dropdown-item .field-move-btn { width: 18px; height: 14px; border: none; background: #f0f0f0; border-radius: 3px; cursor: pointer; font-size: 10px; color: #666; display: flex; align-items: center; justify-content: center; }
        .fields-dropdown-item .field-move-btn:hover { background: #e0e0e0; color: #333; }
        .fields-dropdown-footer { padding: 10px 16px; border-top: 1px solid #eee; background: #fafafa; font-size: 11px; color: #999; }

        /* View-specific toolbar wrapper */
        .toolbar-views { display: flex; align-items: center; gap: 8px; position: relative; }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="auth-box">
            <h2>Amino Viewer</h2>
            <p>Connect to your Amino event stream</p>
            <div id="auth-error" class="auth-error"></div>
            <input type="password" id="api-key-input" placeholder="API Key" autocomplete="off">
            <input type="text" id="set-filter-input" placeholder="Filter by set (optional)" autocomplete="off">
            <button id="auth-submit">Connect</button>
            <button id="auth-clear" class="secondary hidden">Clear Local Data</button>
            <div id="auth-info" class="auth-info"></div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Amino Viewer</h2>
        </div>
        <div id="table-list"></div>
    </div>

    <div class="main">
        <!-- Data Viewer View -->
        <div id="data-view" style="display: flex; flex-direction: column; height: 100%;">
            <div class="toolbar">
                <h1 id="title">Select a table</h1>

                <!-- View Selector -->
                <div class="toolbar-views">
                    <div class="view-selector" id="view-selector-container">
                        <button class="view-selector-btn" id="view-selector-btn" onclick="toggleViewSelector()">
                            <span class="view-icon" id="current-view-icon">&#9638;</span>
                            <span class="view-name" id="current-view-name">All Fields</span>
                            <span class="dropdown-arrow">&#9662;</span>
                        </button>
                        <div class="view-selector-dropdown" id="view-selector-dropdown">
                            <!-- View options will be rendered here -->
                        </div>
                    </div>

                    <!-- Fields Button -->
                    <button class="fields-btn" id="fields-btn" onclick="toggleFieldsDropdown()">
                        <span class="fields-icon">&#9776;</span>
                        <span>Fields</span>
                        <span class="fields-count" id="fields-visible-count">0</span>
                    </button>
                    <div class="fields-dropdown" id="fields-dropdown">
                        <div class="fields-dropdown-header">
                            <h3>Toggle Fields</h3>
                            <div class="fields-dropdown-actions">
                                <button onclick="showAllFields()">Show All</button>
                                <button onclick="hideAllFields()">Hide All</button>
                            </div>
                        </div>
                        <div class="fields-dropdown-list" id="fields-dropdown-list">
                            <!-- Field items will be rendered here -->
                        </div>
                        <div class="fields-dropdown-footer">
                            Drag to reorder â€¢ Click checkbox to toggle
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="manualSync()">Sync</button>
                <button class="btn" onclick="logout()">Logout</button>
            </div>

            <!-- Airtable-style View Controls Bar -->
            <div class="view-controls-bar" id="view-controls-bar">
                <!-- Filter Button -->
                <div class="view-control-wrapper">
                    <button class="view-control-btn" id="filter-btn" onclick="toggleFilterDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M4 8h8M6 12h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                        <span>Filter</span>
                        <span class="control-count" id="filter-count" style="display: none;">0</span>
                    </button>
                    <div class="view-control-dropdown filter-dropdown" id="filter-dropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-header">
                                <span>Filter records</span>
                                <button class="dropdown-action-btn" onclick="addFilter()">+ Add filter</button>
                            </div>
                            <div class="filter-list" id="filter-list">
                                <div class="empty-filters">No filters applied</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sort Button -->
                <div class="view-control-wrapper">
                    <button class="view-control-btn" id="sort-btn" onclick="toggleSortDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 5l2-2 2 2M6 3v10M12 11l-2 2-2-2M10 13V3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span>Sort</span>
                        <span class="control-count" id="sort-count" style="display: none;">0</span>
                    </button>
                    <div class="view-control-dropdown sort-dropdown" id="sort-dropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-header">
                                <span>Sort records</span>
                                <button class="dropdown-action-btn" onclick="addSort()">+ Add sort</button>
                            </div>
                            <div class="sort-list" id="sort-list">
                                <div class="empty-sorts">No sorts applied</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Button -->
                <div class="view-control-wrapper">
                    <button class="view-control-btn" id="group-btn" onclick="toggleGroupDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="5" height="4" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="3" width="5" height="4" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="9" width="5" height="4" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="9" width="5" height="4" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
                        <span>Group</span>
                    </button>
                    <div class="view-control-dropdown group-dropdown" id="group-dropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-header">
                                <span>Group records by</span>
                            </div>
                            <div class="group-options" id="group-options">
                                <div class="group-option none-selected" onclick="setGroupBy(null)">
                                    <span class="check-mark">&#10003;</span>
                                    <span>None</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Button -->
                <div class="view-control-wrapper">
                    <button class="view-control-btn" id="color-btn" onclick="toggleColorDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5"/></svg>
                        <span>Color</span>
                    </button>
                    <div class="view-control-dropdown color-dropdown" id="color-dropdown">
                        <div class="dropdown-section">
                            <div class="dropdown-header">
                                <span>Color records by</span>
                            </div>
                            <div class="color-options" id="color-options">
                                <div class="color-option none-selected" onclick="setColorBy(null)">
                                    <span class="check-mark">&#10003;</span>
                                    <span>None</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row Height Button -->
                <div class="view-control-wrapper">
                    <button class="view-control-btn" id="row-height-btn" onclick="toggleRowHeightDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                        <span>Row height</span>
                    </button>
                    <div class="view-control-dropdown row-height-dropdown" id="row-height-dropdown">
                        <div class="dropdown-section">
                            <div class="row-height-option" onclick="setRowHeight('short')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 6h12M2 10h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                                <span>Short</span>
                            </div>
                            <div class="row-height-option selected" onclick="setRowHeight('medium')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                                <span>Medium</span>
                            </div>
                            <div class="row-height-option" onclick="setRowHeight('tall')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 3h12M2 7h12M2 11h12M2 15h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                                <span>Tall</span>
                            </div>
                            <div class="row-height-option" onclick="setRowHeight('extra-tall')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2h12M2 5h12M2 8h12M2 11h12M2 14h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                                <span>Extra tall</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-controls-spacer"></div>

                <!-- Search -->
                <div class="view-search-wrapper">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5"/><path d="M10.5 10.5L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                    <input type="text" class="view-search-input" id="view-search-input" placeholder="Find in view" oninput="handleViewSearch(this.value)">
                </div>
            </div>
            <div class="status-bar">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Ready</span>
                <div class="progress-bar" id="progress-bar" style="display: none; flex: 1; max-width: 200px;">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <span id="status-detail" style="color: #999; font-size: 11px;"></span>
            </div>
            <div class="table-container" id="table-container">
                <table id="table"></table>
            </div>
            <div class="pagination" id="pagination">
                <button id="prev-btn" onclick="prevPage()">Previous</button>
                <span class="page-info" id="page-info">Page 1</span>
                <button id="next-btn" onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>

    <!-- Field History Modal -->
    <div class="modal-overlay" id="history-modal-overlay" onclick="closeHistoryModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="history-modal-title">Field History</h2>
                <span class="record-id" id="history-modal-record-id"></span>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-toolbar">
                <label>Filter by field:</label>
                <select id="history-field-filter" onchange="filterHistoryByField()">
                    <option value="">All Fields</option>
                </select>
                <span class="history-count" id="history-count"></span>
            </div>
            <div class="modal-body" id="history-modal-body">
                <!-- History items will be rendered here -->
            </div>
        </div>
    </div>

    <script>
var API = 'https://xvkq-pq7i-idtl.n7d.xano.io/api:nrIL-Oi-/aminostream';
var DB_NAME = 'aminostream';
var DB_VERSION = 4;
var PAGE_SIZE = 100;

var API_KEY = null;
var SET_FILTER = null;
var db = null;

// Only keep lightweight metadata in memory
var META_TABLES = {};
var META_FIELDS = {};
var META_VIEWS = {};

var currentTable = null;
var currentView = null; // Current view ID or null for "All Fields" default
var currentPage = 0;
var currentRecordIds = [];
var totalRecords = 0;
var lastEventId = 0;
var pollInterval = null;

// View field configuration cache (in-memory, persisted to IndexedDB)
// Structure: VIEW_FIELD_CONFIG[tableId][viewId] = { visibleFieldIds: [...], fieldOrder: [...] }
var VIEW_FIELD_CONFIG = {};

// ============ IndexedDB ============

function openDB() {
    return new Promise((resolve, reject) => {
        var req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
        req.onupgradeneeded = (e) => {
            var db = e.target.result;

            // Delete old stores if they exist
            if (db.objectStoreNames.contains('records')) {
                db.deleteObjectStore('records');
            }
            if (db.objectStoreNames.contains('meta')) {
                db.deleteObjectStore('meta');
            }

            // Data records: keyed by [tableId, recordId]
            var dataStore = db.createObjectStore('data', { keyPath: ['tableId', 'recordId'] });
            dataStore.createIndex('by_table', 'tableId');

            // Table metadata
            db.createObjectStore('tables', { keyPath: 'tableId' });

            // Field metadata: keyed by [tableId, fieldId]
            var fieldStore = db.createObjectStore('fields', { keyPath: ['tableId', 'fieldId'] });
            fieldStore.createIndex('by_table', 'tableId');

            // View metadata: keyed by [tableId, viewId]
            var viewStore = db.createObjectStore('views', { keyPath: ['tableId', 'viewId'] });
            viewStore.createIndex('by_table', 'tableId');

            // Field history: keyed by auto-increment, indexed by record and field
            if (!db.objectStoreNames.contains('fieldHistory')) {
                var historyStore = db.createObjectStore('fieldHistory', { keyPath: 'id', autoIncrement: true });
                historyStore.createIndex('by_record', ['tableId', 'recordId']);
                historyStore.createIndex('by_field', ['tableId', 'recordId', 'fieldId']);
                historyStore.createIndex('by_event', 'eventId');
            }

            // Sync state
            db.createObjectStore('sync', { keyPath: 'key' });
        };
    });
}

function getSyncMeta(key) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('sync', 'readonly');
        var req = tx.objectStore('sync').get(key);
        req.onsuccess = () => resolve(req.result ? req.result.value : null);
        req.onerror = () => reject(req.error);
    });
}

function setSyncMeta(key, value) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('sync', 'readwrite');
        tx.objectStore('sync').put({ key, value });
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function getAllTables() {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('tables', 'readonly');
        var req = tx.objectStore('tables').getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
    });
}

function getFieldsForTable(tableId) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('fields', 'readonly');
        var index = tx.objectStore('fields').index('by_table');
        var req = index.getAll(tableId);
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
    });
}

function getViewsForTable(tableId) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('views', 'readonly');
        var index = tx.objectStore('views').index('by_table');
        var req = index.getAll(tableId);
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
    });
}

function getAllViews() {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('views', 'readonly');
        var req = tx.objectStore('views').getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
    });
}

function getAllFields() {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('fields', 'readonly');
        var req = tx.objectStore('fields').getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
    });
}

// Query schema elements by recordId prefix
function getSchemaByPrefix(prefix) {
    // Returns tables (tbl*), fields (fld*), or views (viw*) based on prefix
    return new Promise(async (resolve) => {
        var results = [];
        if (prefix === 'tbl') {
            var tables = await getAllTables();
            results = tables.filter(t => t.tableId && t.tableId.startsWith('tbl'));
        } else if (prefix === 'fld') {
            var fields = await getAllFields();
            results = fields.filter(f => f.fieldId && f.fieldId.startsWith('fld'));
        } else if (prefix === 'viw') {
            var views = await getAllViews();
            results = views.filter(v => v.viewId && v.viewId.startsWith('viw'));
        }
        resolve(results);
    });
}

function getRecordIdsForTable(tableId) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('data', 'readonly');
        var index = tx.objectStore('data').index('by_table');
        var req = index.getAllKeys(tableId);
        req.onsuccess = () => {
            // Keys are [tableId, recordId], extract recordIds
            var recordIds = (req.result || []).map(k => k[1]);
            resolve(recordIds);
        };
        req.onerror = () => reject(req.error);
    });
}

function getRecordsByIds(tableId, recordIds) {
    return new Promise((resolve, reject) => {
        if (!recordIds.length) return resolve([]);
        var tx = db.transaction('data', 'readonly');
        var store = tx.objectStore('data');
        var results = [];
        var pending = recordIds.length;

        recordIds.forEach(rid => {
            var req = store.get([tableId, rid]);
            req.onsuccess = () => {
                if (req.result) results.push(req.result);
                if (--pending === 0) resolve(results);
            };
            req.onerror = () => {
                if (--pending === 0) resolve(results);
            };
        });
    });
}

function saveTable(table) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('tables', 'readwrite');
        tx.objectStore('tables').put(table);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function saveField(field) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('fields', 'readwrite');
        tx.objectStore('fields').put(field);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function saveView(view) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('views', 'readwrite');
        tx.objectStore('views').put(view);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function saveDataRecord(record) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('data', 'readwrite');
        tx.objectStore('data').put(record);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function saveBatch(tables, fields, views, dataRecords) {
    return new Promise((resolve, reject) => {
        var stores = [];
        if (tables.length) stores.push('tables');
        if (fields.length) stores.push('fields');
        if (views.length) stores.push('views');
        if (dataRecords.length) stores.push('data');
        if (!stores.length) return resolve();

        var tx = db.transaction(stores, 'readwrite');

        tables.forEach(t => tx.objectStore('tables').put(t));
        fields.forEach(f => tx.objectStore('fields').put(f));
        views.forEach(v => tx.objectStore('views').put(v));
        dataRecords.forEach(d => tx.objectStore('data').put(d));

        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function clearAllData() {
    return new Promise((resolve, reject) => {
        var tx = db.transaction(['data', 'tables', 'fields', 'views', 'sync', 'fieldHistory'], 'readwrite');
        tx.objectStore('data').clear();
        tx.objectStore('tables').clear();
        tx.objectStore('fields').clear();
        tx.objectStore('views').clear();
        tx.objectStore('sync').clear();
        tx.objectStore('fieldHistory').clear();
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function saveFieldHistory(historyEntries) {
    return new Promise((resolve, reject) => {
        if (!historyEntries.length) return resolve();
        var tx = db.transaction('fieldHistory', 'readwrite');
        var store = tx.objectStore('fieldHistory');
        historyEntries.forEach(entry => store.add(entry));
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

function getFieldHistoryForRecord(tableId, recordId) {
    return new Promise((resolve, reject) => {
        var tx = db.transaction('fieldHistory', 'readonly');
        var index = tx.objectStore('fieldHistory').index('by_record');
        var req = index.getAll([tableId, recordId]);
        req.onsuccess = () => {
            // Sort by eventId descending (most recent first)
            var results = req.result || [];
            results.sort((a, b) => (b.eventId || 0) - (a.eventId || 0));
            resolve(results);
        };
        req.onerror = () => reject(req.error);
    });
}

// ============ View Field Configuration ============

// Get the field configuration for a view (from cache or initialize default)
function getViewFieldConfig(tableId, viewId) {
    if (!VIEW_FIELD_CONFIG[tableId]) VIEW_FIELD_CONFIG[tableId] = {};

    // Return cached config if exists
    if (VIEW_FIELD_CONFIG[tableId][viewId]) {
        return VIEW_FIELD_CONFIG[tableId][viewId];
    }

    // Check if view has stored config in META_VIEWS
    var view = META_VIEWS[tableId]?.[viewId];
    if (view && view.visibleFieldIds) {
        VIEW_FIELD_CONFIG[tableId][viewId] = {
            visibleFieldIds: view.visibleFieldIds,
            fieldOrder: view.fieldOrder || view.visibleFieldIds
        };
        return VIEW_FIELD_CONFIG[tableId][viewId];
    }

    // Initialize default config - show all fields in their natural order
    return initViewFieldConfig(tableId, viewId);
}

// Initialize default view field config (all fields visible)
function initViewFieldConfig(tableId, viewId) {
    var fields = META_FIELDS[tableId] || {};
    var fieldIds = Object.keys(fields);

    // Sort fields by name for consistent initial order
    fieldIds.sort((a, b) => {
        var nameA = (fields[a].fieldName || a).toLowerCase();
        var nameB = (fields[b].fieldName || b).toLowerCase();
        return nameA.localeCompare(nameB);
    });

    var config = {
        visibleFieldIds: fieldIds.slice(), // All fields visible initially
        fieldOrder: fieldIds.slice()       // Order matches visible
    };

    if (!VIEW_FIELD_CONFIG[tableId]) VIEW_FIELD_CONFIG[tableId] = {};
    VIEW_FIELD_CONFIG[tableId][viewId] = config;

    return config;
}

// Save view field configuration to memory and IndexedDB
async function saveViewFieldConfig(tableId, viewId, config) {
    // Update cache
    if (!VIEW_FIELD_CONFIG[tableId]) VIEW_FIELD_CONFIG[tableId] = {};
    VIEW_FIELD_CONFIG[tableId][viewId] = config;

    // Update META_VIEWS and persist to IndexedDB
    if (!META_VIEWS[tableId]) META_VIEWS[tableId] = {};
    if (!META_VIEWS[tableId][viewId]) {
        // Create a synthetic view if it doesn't exist
        META_VIEWS[tableId][viewId] = {
            tableId: tableId,
            viewId: viewId,
            viewName: viewId === '_default' ? 'All Fields' : viewId,
            viewType: 'grid'
        };
    }

    // Merge config into view
    META_VIEWS[tableId][viewId].visibleFieldIds = config.visibleFieldIds;
    META_VIEWS[tableId][viewId].fieldOrder = config.fieldOrder;

    // Persist to IndexedDB
    await saveView(META_VIEWS[tableId][viewId]);
}

// Get visible fields for current view in correct order
function getVisibleFieldsForView(tableId, viewId) {
    var config = getViewFieldConfig(tableId, viewId || '_default');
    var fields = META_FIELDS[tableId] || {};

    // Use fieldOrder but filter to only visible fields
    var visibleSet = new Set(config.visibleFieldIds);
    var result = [];

    // First add fields that are in fieldOrder and visible
    for (var fid of config.fieldOrder) {
        if (visibleSet.has(fid) && fields[fid]) {
            result.push(fid);
        }
    }

    // Add any visible fields not in fieldOrder (newly added fields)
    for (var fid of config.visibleFieldIds) {
        if (!result.includes(fid) && fields[fid]) {
            result.push(fid);
        }
    }

    return result;
}

// Get all fields in order (both visible and hidden) for the fields dropdown
function getAllFieldsInOrder(tableId, viewId) {
    var config = getViewFieldConfig(tableId, viewId || '_default');
    var fields = META_FIELDS[tableId] || {};
    var allFieldIds = Object.keys(fields);
    var result = [];
    var addedSet = new Set();

    // First add fields in fieldOrder
    for (var fid of (config.fieldOrder || [])) {
        if (fields[fid] && !addedSet.has(fid)) {
            result.push(fid);
            addedSet.add(fid);
        }
    }

    // Then add any remaining fields (newly added ones)
    for (var fid of allFieldIds) {
        if (!addedSet.has(fid)) {
            result.push(fid);
            addedSet.add(fid);
        }
    }

    return result;
}

// Toggle field visibility for current view
async function toggleFieldVisibility(fieldId) {
    if (!currentTable) return;
    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);

    var idx = config.visibleFieldIds.indexOf(fieldId);
    if (idx >= 0) {
        // Hide field
        config.visibleFieldIds.splice(idx, 1);
    } else {
        // Show field - add at the end
        config.visibleFieldIds.push(fieldId);
        // Also ensure it's in fieldOrder
        if (!config.fieldOrder.includes(fieldId)) {
            config.fieldOrder.push(fieldId);
        }
    }

    await saveViewFieldConfig(currentTable, viewId, config);
    renderFieldsDropdown();
    updateFieldsCount();
    await renderTable();
}

// Move field up in order
async function moveFieldUp(fieldId) {
    if (!currentTable) return;
    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);

    var idx = config.fieldOrder.indexOf(fieldId);
    if (idx > 0) {
        // Swap with previous
        var temp = config.fieldOrder[idx - 1];
        config.fieldOrder[idx - 1] = config.fieldOrder[idx];
        config.fieldOrder[idx] = temp;

        await saveViewFieldConfig(currentTable, viewId, config);
        renderFieldsDropdown();
        await renderTable();
    }
}

// Move field down in order
async function moveFieldDown(fieldId) {
    if (!currentTable) return;
    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);

    var idx = config.fieldOrder.indexOf(fieldId);
    if (idx >= 0 && idx < config.fieldOrder.length - 1) {
        // Swap with next
        var temp = config.fieldOrder[idx + 1];
        config.fieldOrder[idx + 1] = config.fieldOrder[idx];
        config.fieldOrder[idx] = temp;

        await saveViewFieldConfig(currentTable, viewId, config);
        renderFieldsDropdown();
        await renderTable();
    }
}

// Show all fields
async function showAllFields() {
    if (!currentTable) return;
    var viewId = currentView || '_default';
    var fields = META_FIELDS[currentTable] || {};
    var allFieldIds = Object.keys(fields);

    var config = getViewFieldConfig(currentTable, viewId);
    config.visibleFieldIds = allFieldIds.slice();

    // Ensure all fields are in fieldOrder
    for (var fid of allFieldIds) {
        if (!config.fieldOrder.includes(fid)) {
            config.fieldOrder.push(fid);
        }
    }

    await saveViewFieldConfig(currentTable, viewId, config);
    renderFieldsDropdown();
    updateFieldsCount();
    await renderTable();
}

// Hide all fields (except keep at least one visible)
async function hideAllFields() {
    if (!currentTable) return;
    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);

    // Keep the first field visible
    if (config.fieldOrder.length > 0) {
        config.visibleFieldIds = [config.fieldOrder[0]];
    } else {
        config.visibleFieldIds = [];
    }

    await saveViewFieldConfig(currentTable, viewId, config);
    renderFieldsDropdown();
    updateFieldsCount();
    await renderTable();
}

function getLocalStats() {
    return new Promise(async (resolve) => {
        try {
            var tempDb = await openDB();
            var count = await new Promise((res, rej) => {
                var tx = tempDb.transaction('data', 'readonly');
                var req = tx.objectStore('data').count();
                req.onsuccess = () => res(req.result);
                req.onerror = () => res(0);
            });
            var lastId = await new Promise((res, rej) => {
                var tx = tempDb.transaction('sync', 'readonly');
                var req = tx.objectStore('sync').get('lastEventId');
                req.onsuccess = () => res(req.result ? req.result.value : 0);
                req.onerror = () => res(0);
            });
            tempDb.close();
            resolve({ count, lastId });
        } catch (e) {
            resolve({ count: 0, lastId: 0 });
        }
    });
}

// ============ Auth ============

document.getElementById('auth-submit').onclick = tryAuth;
document.getElementById('api-key-input').onkeydown = (e) => { if (e.key === 'Enter') tryAuth(); };
document.getElementById('set-filter-input').onkeydown = (e) => { if (e.key === 'Enter') tryAuth(); };
document.getElementById('auth-clear').onclick = clearLocalAndReset;

async function initAuthScreen() {
    var stats = await getLocalStats();
    var infoEl = document.getElementById('auth-info');
    var clearBtn = document.getElementById('auth-clear');

    if (stats.count > 0) {
        infoEl.textContent = 'Local cache: ' + stats.count.toLocaleString() + ' records';
        clearBtn.classList.remove('hidden');
    } else {
        infoEl.textContent = 'No local data';
        clearBtn.classList.add('hidden');
    }
}

async function clearLocalAndReset() {
    if (!confirm('Clear all local data?')) return;
    try {
        db = await openDB();
        await clearAllData();
        db.close();
        db = null;
    } catch (e) {
        console.error('Clear error:', e);
    }
    initAuthScreen();
}

async function tryAuth() {
    var key = document.getElementById('api-key-input').value.trim();
    if (!key) {
        showAuthError('Please enter an API key');
        return;
    }

    var btn = document.getElementById('auth-submit');
    btn.textContent = 'Connecting...';
    btn.disabled = true;
    document.getElementById('auth-error').style.display = 'none';

    API_KEY = key;
    SET_FILTER = document.getElementById('set-filter-input').value.trim() || null;

    try {
        await init();
    } catch (err) {
        console.error('Init error:', err);
        showAuthError('Connection failed: ' + err.message);
        btn.textContent = 'Connect';
        btn.disabled = false;
        return;
    }

    btn.textContent = 'Connect';
    btn.disabled = false;
}

function showAuthError(msg) {
    var el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
}

function hideAuthScreen() {
    document.getElementById('auth-screen').classList.add('hidden');
}

function showAuthScreen() {
    document.getElementById('auth-screen').classList.remove('hidden');
    if (pollInterval) clearInterval(pollInterval);
    initAuthScreen();
}

function logout() {
    if (pollInterval) clearInterval(pollInterval);
    API_KEY = null;
    SET_FILTER = null;
    showAuthScreen();
}

async function manualSync() {
    if (!API_KEY) return;
    await incrementalSync();
}

// ============ Data Processing ============

function parsePayload(payload) {
    if (typeof payload === 'string') {
        try { return JSON.parse(payload); } catch { return null; }
    }
    return payload;
}

async function processEvents(events) {
    if (!events || !Array.isArray(events)) return;

    var tables = [];
    var fields = [];
    var views = [];
    var dataRecords = [];
    var fieldHistoryEntries = [];
    var tableDataMap = {}; // tableId -> { recordId -> fields }

    for (var e of events) {
        if (!e || !e.set || !e.recordId) continue;

        var payload = parsePayload(e.payload);
        if (!payload || typeof payload !== 'object') continue;

        var recordType = payload._set;
        var setName = e.set;
        var recordId = e.recordId;
        var eventId = e.id;
        var timestamp = Date.now(); // Use current time as timestamp

        if (recordType === 'table') {
            // Tables: recordId starts with "tbl", set points to base
            var tableId = recordId;
            var tableData = { tableId };
            applyPayloadFields(tableData, payload);
            if (payload.tableName) tableData.tableName = payload.tableName;
            if (payload.primaryFieldId) tableData.primaryFieldId = payload.primaryFieldId;
            if (payload.tableId) tableData.tableId = payload.tableId;
            tables.push(tableData);
            META_TABLES[tableId] = tableData;

        } else if (recordType === 'field') {
            // Fields: recordId starts with "fld", set points to table
            var tableId = payload.tableId || setName.replace('airtable:', '');
            var fieldId = recordId;
            var fieldData = { tableId, fieldId };
            applyPayloadFields(fieldData, payload);
            if (payload.fieldName) fieldData.fieldName = payload.fieldName;
            if (payload.fieldType) fieldData.fieldType = payload.fieldType;
            if (payload.fieldId) fieldData.fieldId = payload.fieldId;
            if (payload.options) fieldData.options = payload.options;
            fields.push(fieldData);
            if (!META_FIELDS[tableId]) META_FIELDS[tableId] = {};
            META_FIELDS[tableId][fieldId] = fieldData;

        } else if (recordType === 'view') {
            // Views: recordId starts with "viw", set points to table
            var tableId = payload.tableId || setName.replace('airtable:', '');
            var viewId = recordId;
            var viewData = { tableId, viewId };
            applyPayloadFields(viewData, payload);
            if (payload.viewName) viewData.viewName = payload.viewName;
            if (payload.viewType) viewData.viewType = payload.viewType;
            if (payload.viewId) viewData.viewId = payload.viewId;
            views.push(viewData);
            if (!META_VIEWS[tableId]) META_VIEWS[tableId] = {};
            META_VIEWS[tableId][viewId] = viewData;

        } else {
            // Data record: recordId starts with "rec"
            var tableId = setName.replace('airtable:', '');
            var pfields = payload.fields;
            if (!pfields || typeof pfields !== 'object') continue;

            if (!tableDataMap[tableId]) tableDataMap[tableId] = {};
            if (!tableDataMap[tableId][recordId]) {
                // Try to get existing record from db
                tableDataMap[tableId][recordId] = {};
            }

            var state = tableDataMap[tableId][recordId];

            // Capture field history for INS (insert/create)
            if (pfields.INS) {
                for (var fieldId in pfields.INS) {
                    fieldHistoryEntries.push({
                        tableId: tableId,
                        recordId: recordId,
                        fieldId: fieldId,
                        eventId: eventId,
                        timestamp: timestamp,
                        changeType: 'created',
                        oldValue: null,
                        newValue: pfields.INS[fieldId]
                    });
                }
                Object.assign(state, pfields.INS);
            }

            // Capture field history for ALT (alter/update)
            if (pfields.ALT) {
                for (var fieldId in pfields.ALT) {
                    fieldHistoryEntries.push({
                        tableId: tableId,
                        recordId: recordId,
                        fieldId: fieldId,
                        eventId: eventId,
                        timestamp: timestamp,
                        changeType: 'updated',
                        oldValue: state[fieldId] !== undefined ? state[fieldId] : null,
                        newValue: pfields.ALT[fieldId]
                    });
                }
                Object.assign(state, pfields.ALT);
            }

            // Capture field history for NUL (nullify/delete)
            if (pfields.NUL && Array.isArray(pfields.NUL)) {
                pfields.NUL.forEach(fieldId => {
                    fieldHistoryEntries.push({
                        tableId: tableId,
                        recordId: recordId,
                        fieldId: fieldId,
                        eventId: eventId,
                        timestamp: timestamp,
                        changeType: 'deleted',
                        oldValue: state[fieldId] !== undefined ? state[fieldId] : null,
                        newValue: null
                    });
                    delete state[fieldId];
                });
            }
        }

        if (e.id && e.id > lastEventId) {
            lastEventId = e.id;
        }
    }

    // Convert tableDataMap to dataRecords array
    for (var tableId in tableDataMap) {
        for (var recordId in tableDataMap[tableId]) {
            dataRecords.push({
                tableId,
                recordId,
                fields: tableDataMap[tableId][recordId]
            });
        }
    }

    // Save batch
    if (tables.length || fields.length || views.length || dataRecords.length) {
        await saveBatch(tables, fields, views, dataRecords);
    }

    // Save field history
    if (fieldHistoryEntries.length) {
        await saveFieldHistory(fieldHistoryEntries);
    }
}

function applyPayloadFields(target, payload) {
    if (!payload.fields) return;
    var fields = payload.fields;
    if (fields.INS) Object.assign(target, fields.INS);
    if (fields.ALT) Object.assign(target, fields.ALT);
    if (fields.NUL && Array.isArray(fields.NUL)) {
        fields.NUL.forEach(k => delete target[k]);
    }
}

// ============ UI ============

async function renderSidebar() {
    var tableList = document.getElementById('table-list');
    tableList.innerHTML = '';

    var tables = await getAllTables();

    // Also get tables from META_TABLES (in-memory from current session)
    for (var tid in META_TABLES) {
        if (!tables.find(t => t.tableId === tid)) {
            tables.push(META_TABLES[tid]);
        }
    }

    tables.sort((a, b) => (a.tableName || a.tableId).localeCompare(b.tableName || b.tableId));

    for (var table of tables) {
        var tableId = table.tableId;
        var tableName = table.tableName || tableId;

        // Create wrapper for table item and its views
        var wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        wrapper.setAttribute('data-table-id', tableId);

        // Create table item
        var div = document.createElement('div');
        div.className = 'table-item' + (tableId === currentTable ? ' active expanded' : '');
        div.innerHTML = '<span class="table-icon"></span>' + esc(tableName) +
                        '<span class="count" id="count-' + tableId + '"></span>' +
                        '<span class="expand-arrow">&#9654;</span>';
        div.onclick = ((t) => (e) => toggleTableViews(t, e))(tableId);
        wrapper.appendChild(div);

        // Create views list container
        var viewsList = document.createElement('div');
        viewsList.className = 'table-views-list' + (tableId === currentTable ? ' expanded' : '');
        viewsList.id = 'views-list-' + tableId;
        viewsList.innerHTML = '<div class="table-view-item loading" style="color: #666; font-style: italic;">Loading views...</div>';
        wrapper.appendChild(viewsList);

        tableList.appendChild(wrapper);

        // Load views for this table asynchronously
        loadTableViewsAsync(tableId);
    }

    // Update counts asynchronously
    for (var table of tables) {
        getRecordIdsForTable(table.tableId).then(((tid) => (ids) => {
            var el = document.getElementById('count-' + tid);
            if (el) el.textContent = ids.length.toLocaleString();
        })(table.tableId));
    }
}

// Load views for a table and populate the views list
async function loadTableViewsAsync(tableId) {
    var viewsList = document.getElementById('views-list-' + tableId);
    if (!viewsList) return;

    var views = await getViewsForTable(tableId);

    // Cache views in META_VIEWS
    if (!META_VIEWS[tableId]) META_VIEWS[tableId] = {};
    views.forEach(v => META_VIEWS[tableId][v.viewId] = v);

    var html = '';

    // Add "All Fields" default option first
    var isDefaultActive = currentTable === tableId && (!currentView || currentView === '_default');
    html += '<div class="table-view-item' + (isDefaultActive ? ' active' : '') + '" onclick="selectTableView(\'' + esc(tableId) + '\', \'_default\')">' +
            '<span class="view-icon">&#9638;</span>' +
            '<span class="view-name table-view-default">All Fields</span>' +
            '</div>';

    // Add each view
    var viewIds = Object.keys(META_VIEWS[tableId] || {});
    for (var vid of viewIds) {
        if (vid === '_default') continue;
        var view = META_VIEWS[tableId][vid];
        var isActive = currentTable === tableId && currentView === vid;
        var viewName = view.viewName || vid;
        var viewIcon = getViewTypeIcon(view.viewType);

        html += '<div class="table-view-item' + (isActive ? ' active' : '') + '" onclick="selectTableView(\'' + esc(tableId) + '\', \'' + esc(vid) + '\')">' +
                '<span class="view-icon">' + viewIcon + '</span>' +
                '<span class="view-name">' + esc(viewName) + '</span>' +
                '</div>';
    }

    viewsList.innerHTML = html;
}

// Toggle the expanded views list for a table
function toggleTableViews(tableId, event) {
    event.stopPropagation();

    var wrapper = document.querySelector('.table-wrapper[data-table-id="' + tableId + '"]');
    if (!wrapper) return;

    var tableItem = wrapper.querySelector('.table-item');
    var viewsList = wrapper.querySelector('.table-views-list');

    if (tableItem.classList.contains('expanded')) {
        // Collapse
        tableItem.classList.remove('expanded');
        viewsList.classList.remove('expanded');
    } else {
        // Expand
        tableItem.classList.add('expanded');
        viewsList.classList.add('expanded');
    }
}

// Select a view from the sidebar and show the table
async function selectTableView(tableId, viewId) {
    // Update sidebar active states
    document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.table-view-item').forEach(el => el.classList.remove('active'));

    var wrapper = document.querySelector('.table-wrapper[data-table-id="' + tableId + '"]');
    if (wrapper) {
        wrapper.querySelector('.table-item').classList.add('active');
        // Find and mark the selected view as active
        var viewItems = wrapper.querySelectorAll('.table-view-item');
        viewItems.forEach(item => {
            var onclickAttr = item.getAttribute('onclick') || '';
            if (onclickAttr.includes("'" + viewId + "'")) {
                item.classList.add('active');
            }
        });
    }

    // If switching to a different table, load it first
    if (currentTable !== tableId) {
        currentTable = tableId;
        currentPage = 0;

        var table = META_TABLES[tableId] || (await getAllTables()).find(t => t.tableId === tableId) || {};
        var tableName = table.tableName || tableId;
        document.getElementById('title').textContent = tableName;

        // Show loading state immediately
        showTableLoading('Loading table structure...');

        // Load fields first (table structure)
        var fields = await getFieldsForTable(tableId);
        META_FIELDS[tableId] = {};
        fields.forEach(f => META_FIELDS[tableId][f.fieldId] = f);

        // Load views for this table
        var views = await getViewsForTable(tableId);
        META_VIEWS[tableId] = {};
        views.forEach(v => META_VIEWS[tableId][v.viewId] = v);

        // Load record IDs
        currentRecordIds = await getRecordIdsForTable(tableId);
        totalRecords = currentRecordIds.length;
    }

    // Set the current view
    currentView = viewId;

    // Render view selector and fields dropdown
    renderViewSelector();
    renderFieldsDropdown();
    updateFieldsCount();

    // Render the table
    await renderTable();
}

function updateStatus(msg, isSynced, progress, detail) {
    var dot = document.getElementById('status-dot');
    var text = document.getElementById('status-text');
    var progressBar = document.getElementById('progress-bar');
    var progressFill = document.getElementById('progress-fill');
    var statusDetail = document.getElementById('status-detail');

    dot.className = 'status-dot ' + (isSynced ? 'synced' : 'loading');
    text.textContent = msg;

    if (typeof progress === 'number' && progress >= 0) {
        progressBar.style.display = 'block';
        progressFill.style.width = Math.min(100, progress) + '%';
    } else {
        progressBar.style.display = 'none';
    }

    statusDetail.textContent = detail || '';
}

async function showTable(tableId) {
    currentTable = tableId;
    currentView = null; // Reset view when switching tables
    currentPage = 0;

    // Reset view controls when switching tables
    if (typeof currentFilters !== 'undefined') currentFilters = [];
    if (typeof currentSorts !== 'undefined') currentSorts = [];
    if (typeof currentGroupBy !== 'undefined') currentGroupBy = null;
    if (typeof currentColorBy !== 'undefined') currentColorBy = null;
    if (typeof currentSearchQuery !== 'undefined') currentSearchQuery = '';

    // Reset filter/sort/group button states
    var filterBtn = document.getElementById('filter-btn');
    var sortBtn = document.getElementById('sort-btn');
    var groupBtn = document.getElementById('group-btn');
    var colorBtn = document.getElementById('color-btn');
    var searchInput = document.getElementById('view-search-input');
    if (filterBtn) filterBtn.classList.remove('active');
    if (sortBtn) sortBtn.classList.remove('active');
    if (groupBtn) groupBtn.classList.remove('active');
    if (colorBtn) colorBtn.classList.remove('active');
    if (searchInput) searchInput.value = '';
    document.getElementById('filter-count')?.style.setProperty('display', 'none');
    document.getElementById('sort-count')?.style.setProperty('display', 'none');

    var table = META_TABLES[tableId] || (await getAllTables()).find(t => t.tableId === tableId) || {};
    var tableName = table.tableName || tableId;

    document.getElementById('title').textContent = tableName;

    // Update sidebar - expand the selected table and highlight it
    document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.table-view-item').forEach(el => el.classList.remove('active'));

    var wrapper = document.querySelector('.table-wrapper[data-table-id="' + tableId + '"]');
    if (wrapper) {
        var tableItem = wrapper.querySelector('.table-item');
        var viewsList = wrapper.querySelector('.table-views-list');
        if (tableItem) {
            tableItem.classList.add('active', 'expanded');
        }
        if (viewsList) {
            viewsList.classList.add('expanded');
        }
    }

    // Show loading state immediately
    showTableLoading('Loading table structure...');

    // Load fields first (table structure)
    var fields = await getFieldsForTable(tableId);
    META_FIELDS[tableId] = {};
    fields.forEach(f => META_FIELDS[tableId][f.fieldId] = f);

    // Load views for this table
    var views = await getViewsForTable(tableId);
    META_VIEWS[tableId] = {};
    views.forEach(v => META_VIEWS[tableId][v.viewId] = v);

    // Set current view to the first available view or default
    var viewIds = Object.keys(META_VIEWS[tableId] || {});
    if (viewIds.length > 0 && !currentView) {
        // Check if there's a saved preference or use first view
        currentView = viewIds[0];
    } else if (!currentView) {
        currentView = '_default';
    }

    // Update the view list to highlight the active view
    updateSidebarViewActive(tableId, currentView);

    // Render view selector and fields dropdown
    renderViewSelector();
    renderFieldsDropdown();
    updateFieldsCount();

    // Show table headers immediately with skeleton rows (even before data loads)
    renderTableHeaders();

    // Update status (don't overwrite table headers with loading spinner)
    updateStatus('Loading records...', false, null, null);

    // Load record IDs
    currentRecordIds = await getRecordIdsForTable(tableId);
    totalRecords = currentRecordIds.length;

    // Now render full table with data
    await renderTable();
}

// Update the sidebar to highlight the active view
function updateSidebarViewActive(tableId, viewId) {
    var wrapper = document.querySelector('.table-wrapper[data-table-id="' + tableId + '"]');
    if (!wrapper) return;

    var viewItems = wrapper.querySelectorAll('.table-view-item');
    viewItems.forEach(item => {
        item.classList.remove('active');
        var onclickAttr = item.getAttribute('onclick') || '';
        if (onclickAttr.includes("'" + viewId + "'")) {
            item.classList.add('active');
        }
    });
}

function showTableLoading(message) {
    var container = document.getElementById('table-container');
    container.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><h3>' + esc(message) + '</h3></div>';
    document.getElementById('pagination').style.display = 'none';
}

function renderTableHeaders() {
    if (!currentTable) return;

    var container = document.getElementById('table-container');
    var fields = META_FIELDS[currentTable] || {};

    // Use view field configuration for visible fields
    var viewId = currentView || '_default';
    var colList = getVisibleFieldsForView(currentTable, viewId);

    if (colList.length === 0) {
        // No visible fields, show empty state
        container.innerHTML = '<div class="empty-state"><h3>No visible fields</h3><p>Click the Fields button to show columns</p></div>';
        return;
    }

    var colNames = {};
    colList.forEach(fid => {
        colNames[fid] = fields[fid]?.fieldName || fid;
    });

    // Build table with headers and skeleton rows
    var html = '<table id="table"><thead><tr><th style="width: 70px;">Actions</th><th>ID</th>';
    colList.forEach(col => {
        html += '<th title="' + esc(col) + '">' + esc(colNames[col]) + '</th>';
    });
    html += '</tr></thead><tbody>';

    // Add skeleton loading rows
    for (var i = 0; i < 5; i++) {
        html += '<tr class="skeleton-row"><td><div class="skeleton-cell" style="width: 50px;"></div></td><td><div class="skeleton-cell" style="width: 60px;"></div></td>';
        colList.forEach(() => {
            html += '<td><div class="skeleton-cell" style="width: ' + (60 + Math.random() * 80) + 'px;"></div></td>';
        });
        html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = html;
}

async function renderTable() {
    if (!currentTable) return;

    var tableEl = document.getElementById('table');
    var pageRecordIds = currentRecordIds.slice(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE);

    if (pageRecordIds.length === 0) {
        tableEl.innerHTML = '';
        document.getElementById('table-container').innerHTML = '<div class="empty-state"><h3>No records</h3><p>This table is empty</p></div>';
        document.getElementById('pagination').style.display = 'none';
        return;
    }

    document.getElementById('table-container').innerHTML = '<table id="table"></table>';
    tableEl = document.getElementById('table');

    // Get records for current page
    var records = await getRecordsByIds(currentTable, pageRecordIds);
    var recordMap = {};
    records.forEach(r => recordMap[r.recordId] = r.fields || {});

    // Get columns from view configuration
    var fields = META_FIELDS[currentTable] || {};
    var viewId = currentView || '_default';
    var colList = getVisibleFieldsForView(currentTable, viewId);

    // If no visible fields but we have data, initialize with all fields
    if (colList.length === 0 && Object.keys(fields).length === 0) {
        // Discover from data
        var colSet = {};
        records.forEach(r => {
            if (r.fields) Object.keys(r.fields).forEach(k => colSet[k] = true);
        });
        colList = Object.keys(colSet).sort();
    }

    var colNames = {};
    colList.forEach(fid => {
        colNames[fid] = fields[fid]?.fieldName || fid;
    });

    // Build table
    var html = '<thead><tr><th style="width: 70px;">Actions</th><th>ID</th>';
    colList.forEach(col => {
        html += '<th title="' + esc(col) + '">' + esc(colNames[col]) + '</th>';
    });
    html += '</tr></thead><tbody>';

    pageRecordIds.forEach(rid => {
        var row = recordMap[rid] || {};
        html += '<tr>';
        // History button
        html += '<td><button class="history-btn" onclick="openHistoryModal(\'' + esc(currentTable) + '\', \'' + esc(rid) + '\')" title="View field history">';
        html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>';
        html += 'History</button></td>';
        html += '<td>' + esc(rid.slice(-8)) + '</td>';
        colList.forEach(col => {
            var value = row[col];
            if (value === undefined) value = row[colNames[col]];
            html += '<td>' + formatCell(value) + '</td>';
        });
        html += '</tr>';
    });

    html += '</tbody>';
    tableEl.innerHTML = html;

    // Update pagination
    updatePagination();
}

function formatCell(v) {
    if (v == null || v === '') {
        return '<span class="cell-empty">â€”</span>';
    }

    if (Array.isArray(v)) {
        if (v.length === 0) return '<span class="cell-empty">â€”</span>';

        // Check if it's an array of objects (linked records, attachments, etc.)
        if (typeof v[0] === 'object' && v[0] !== null) {
            var items = v.map(item => {
                if (item.name) return item.name;
                if (item.filename) return item.filename;
                if (item.email) return item.email;
                if (item.id) return item.id;
                return JSON.stringify(item).slice(0, 30);
            });
            return '<span class="cell-array">' + items.map(i => '<span class="tag">' + esc(i) + '</span>').join('') + '</span>';
        }

        // Simple array - join with commas
        return '<span class="cell-array">' + v.map(i => '<span class="tag">' + esc(String(i)) + '</span>').join('') + '</span>';
    }

    if (typeof v === 'object') {
        // Single object
        if (v.name) return esc(v.name);
        if (v.filename) return esc(v.filename);
        if (v.email) return esc(v.email);
        if (v.url) return '<a class="cell-link" href="' + esc(v.url) + '" target="_blank">' + esc(v.url.slice(0, 40)) + '</a>';
        return esc(JSON.stringify(v).slice(0, 50));
    }

    if (typeof v === 'boolean') {
        return '<span class="cell-bool ' + v + '">' + (v ? 'Yes' : 'No') + '</span>';
    }

    if (typeof v === 'number') {
        return '<span class="cell-number">' + v.toLocaleString() + '</span>';
    }

    // String - check for URLs
    var str = String(v);
    if (str.startsWith('http://') || str.startsWith('https://')) {
        return '<a class="cell-link" href="' + esc(str) + '" target="_blank">' + esc(str.slice(0, 50)) + '</a>';
    }

    return esc(str);
}

function updatePagination() {
    var totalPages = Math.ceil(totalRecords / PAGE_SIZE);
    var start = currentPage * PAGE_SIZE + 1;
    var end = Math.min((currentPage + 1) * PAGE_SIZE, totalRecords);

    document.getElementById('page-info').textContent = start + '-' + end + ' of ' + totalRecords.toLocaleString();
    document.getElementById('prev-btn').disabled = currentPage === 0;
    document.getElementById('next-btn').disabled = currentPage >= totalPages - 1;
    document.getElementById('pagination').style.display = totalRecords > PAGE_SIZE ? 'flex' : 'none';
}

function prevPage() {
    if (currentPage > 0) {
        currentPage--;
        renderTable();
    }
}

function nextPage() {
    var totalPages = Math.ceil(totalRecords / PAGE_SIZE);
    if (currentPage < totalPages - 1) {
        currentPage++;
        renderTable();
    }
}

// ============ API ============

async function fetchPage(page, afterId) {
    var url = API + '?page=' + page + '&per_page=500';
    if (API_KEY) url += '&apiKey=' + encodeURIComponent(API_KEY);
    if (afterId) url += '&id=' + afterId;
    if (SET_FILTER) url += '&set=' + encodeURIComponent(SET_FILTER);

    var res = await fetch(url);

    if (res.status === 401 || res.status === 403) {
        throw new Error('Invalid API key');
    }

    var data = await res.json();

    if (!res.ok) {
        throw new Error(data.message || data.error || 'HTTP ' + res.status);
    }

    var events = Array.isArray(data) ? data : (data.items || data.data || []);
    var hasMore = Array.isArray(data) ? events.length >= 500 : !!data.nextPage;
    var nextPage = Array.isArray(data) ? page + 1 : data.nextPage;

    return { events, hasMore, nextPage };
}

async function fullSync() {
    var page = 1;
    var eventsLoaded = 0;
    var tablesFound = 0;
    var fieldsFound = 0;
    var viewsFound = 0;
    var recordsFound = 0;

    while (true) {
        // Show progress with estimates (assume ~50 pages max for progress bar)
        var progressPct = Math.min(95, (page / 50) * 100);
        var detail = tablesFound + ' tables, ' + fieldsFound + ' fields, ' + viewsFound + ' views, ' + recordsFound.toLocaleString() + ' records';
        updateStatus('Syncing page ' + page + '...', false, progressPct, detail);

        var result = await fetchPage(page, null);
        if (!result.events || result.events.length === 0) break;

        eventsLoaded += result.events.length;
        result.events.sort((a, b) => (a.id || 0) - (b.id || 0));

        // Count what we're processing for feedback
        for (var e of result.events) {
            var payload = parsePayload(e.payload);
            if (payload && payload._set === 'table') tablesFound++;
            else if (payload && payload._set === 'field') fieldsFound++;
            else if (payload && payload._set === 'view') viewsFound++;
            else recordsFound++;
        }

        await processEvents(result.events);

        // Update sidebar after EVERY page to show tables/fields as they arrive
        await renderSidebar();

        // Auto-select first table and refresh view
        if (!currentTable && Object.keys(META_TABLES).length > 0) {
            var firstTable = Object.keys(META_TABLES)[0];
            await showTable(firstTable);
        } else if (currentTable) {
            // Refresh current table view to show new data
            currentRecordIds = await getRecordIdsForTable(currentTable);
            totalRecords = currentRecordIds.length;
            await renderTable();
        }

        if (!result.hasMore) break;
        page = result.nextPage || page + 1;
        if (page > 500) break;
    }

    await setSyncMeta('lastEventId', lastEventId);
    var finalDetail = tablesFound + ' tables, ' + fieldsFound + ' fields, ' + viewsFound + ' views, ' + recordsFound.toLocaleString() + ' records';
    updateStatus('Synced ' + eventsLoaded.toLocaleString() + ' events', true, null, finalDetail);
}

async function incrementalSync() {
    try {
        updateStatus('Checking for updates...', false, null, null);

        var result = await fetchPage(1, lastEventId);

        if (result.events && result.events.length > 0) {
            updateStatus('Processing ' + result.events.length + ' new events...', false, null, null);
            result.events.sort((a, b) => (a.id || 0) - (b.id || 0));
            await processEvents(result.events);
            await setSyncMeta('lastEventId', lastEventId);

            updateStatus('Updating views...', false, null, null);
            await renderSidebar();

            // Update data view if table is selected
            if (currentTable) {
                currentRecordIds = await getRecordIdsForTable(currentTable);
                totalRecords = currentRecordIds.length;
                await renderTable();
            }

            updateStatus('Up to date', true, null, result.events.length + ' events synced');
        } else {
            updateStatus('Up to date', true, null, null);
        }
    } catch (err) {
        console.error('Sync error:', err);
        updateStatus('Sync error: ' + err.message, false, null, null);
    }
}

// ============ Init ============

async function init() {
    META_TABLES = {};
    META_FIELDS = {};
    META_VIEWS = {};
    currentTable = null;
    currentPage = 0;
    currentRecordIds = [];
    totalRecords = 0;
    lastEventId = 0;

    db = await openDB();

    updateStatus('Loading local data...', false, null, null);

    var storedLastId = await getSyncMeta('lastEventId');
    var tables = await getAllTables();
    var fields = await getAllFields();
    var views = await getAllViews();

    // Load metadata into memory
    tables.forEach(t => META_TABLES[t.tableId] = t);
    fields.forEach(f => {
        if (!META_FIELDS[f.tableId]) META_FIELDS[f.tableId] = {};
        META_FIELDS[f.tableId][f.fieldId] = f;
    });
    views.forEach(v => {
        if (!META_VIEWS[v.tableId]) META_VIEWS[v.tableId] = {};
        META_VIEWS[v.tableId][v.viewId] = v;
    });

    hideAuthScreen();

    if (tables.length > 0) {
        updateStatus('Found ' + tables.length + ' tables', false, null, 'Loading data...');
        await renderSidebar();

        // Auto-select first table
        var firstTable = Object.keys(META_TABLES)[0];
        if (firstTable) {
            await showTable(firstTable);
        }

        lastEventId = storedLastId || 0;
        await incrementalSync();
    } else {
        updateStatus('Starting initial sync...', false, 0, 'Fetching data from server...');
        await renderSidebar();
        await fullSync();
        await renderSidebar();
    }

    updateStatus('Up to date', true, null, null);

    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(incrementalSync, 60000);
}

// ============ Field History Modal ============

var currentHistoryData = [];
var currentHistoryRecordId = null;
var currentHistoryTableId = null;

async function openHistoryModal(tableId, recordId) {
    currentHistoryTableId = tableId;
    currentHistoryRecordId = recordId;

    // Set modal title
    var tableName = META_TABLES[tableId]?.tableName || tableId;
    document.getElementById('history-modal-title').textContent = 'Field History - ' + tableName;
    document.getElementById('history-modal-record-id').textContent = recordId;

    // Show modal with loading state
    var overlay = document.getElementById('history-modal-overlay');
    var body = document.getElementById('history-modal-body');
    body.innerHTML = '<div class="modal-empty"><div class="loading-spinner"></div><h3>Loading history...</h3></div>';
    overlay.classList.add('open');

    // Fetch history data
    try {
        currentHistoryData = await getFieldHistoryForRecord(tableId, recordId);
        renderHistoryModal();
    } catch (err) {
        console.error('Error loading history:', err);
        body.innerHTML = '<div class="modal-empty"><h3>Error loading history</h3><p>' + esc(err.message) + '</p></div>';
    }
}

function closeHistoryModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('history-modal-overlay').classList.remove('open');
    currentHistoryData = [];
    currentHistoryRecordId = null;
    currentHistoryTableId = null;
}

function renderHistoryModal() {
    var body = document.getElementById('history-modal-body');
    var filterSelect = document.getElementById('history-field-filter');
    var countEl = document.getElementById('history-count');

    if (!currentHistoryData || currentHistoryData.length === 0) {
        body.innerHTML = '<div class="modal-empty"><h3>No history available</h3><p>Field changes will appear here after the next sync</p></div>';
        filterSelect.innerHTML = '<option value="">All Fields</option>';
        countEl.textContent = '0 changes';
        return;
    }

    // Build field filter options
    var fieldIds = [...new Set(currentHistoryData.map(h => h.fieldId))];
    var fields = META_FIELDS[currentHistoryTableId] || {};

    var filterHtml = '<option value="">All Fields</option>';
    fieldIds.forEach(fid => {
        var fieldName = fields[fid]?.fieldName || fid;
        filterHtml += '<option value="' + esc(fid) + '">' + esc(fieldName) + '</option>';
    });
    filterSelect.innerHTML = filterHtml;

    // Get selected filter
    var selectedField = filterSelect.value;
    var filteredData = selectedField
        ? currentHistoryData.filter(h => h.fieldId === selectedField)
        : currentHistoryData;

    countEl.textContent = filteredData.length + ' change' + (filteredData.length !== 1 ? 's' : '');

    // Render history items
    var html = '<div class="history-timeline">';

    for (var item of filteredData) {
        var fieldName = fields[item.fieldId]?.fieldName || item.fieldId;
        var changeTypeClass = item.changeType || 'updated';
        var timestamp = item.timestamp ? formatTimestamp(item.timestamp) : 'Unknown time';

        html += '<div class="history-item">';
        html += '<div class="history-item-header">';
        html += '<span class="history-field-name">' + esc(fieldName) + '</span>';
        html += '<span class="history-change-type ' + changeTypeClass + '">' + changeTypeClass + '</span>';
        html += '<span class="history-timestamp">' + esc(timestamp) + '</span>';
        html += '<span class="history-event-id">Event #' + (item.eventId || '?') + '</span>';
        html += '</div>';

        html += '<div class="history-values">';

        // Old value
        if (item.changeType !== 'created') {
            html += '<div class="history-value-box ' + (item.oldValue === null ? 'null' : 'old') + '">';
            html += '<div class="history-value-label">Previous</div>';
            html += '<div class="history-value-content">' + formatHistoryValue(item.oldValue) + '</div>';
            html += '</div>';
            html += '<span class="history-arrow">&#8594;</span>';
        }

        // New value
        html += '<div class="history-value-box ' + (item.newValue === null ? 'null' : 'new') + '">';
        html += '<div class="history-value-label">' + (item.changeType === 'created' ? 'Initial Value' : 'New Value') + '</div>';
        html += '<div class="history-value-content">' + formatHistoryValue(item.newValue) + '</div>';
        html += '</div>';

        html += '</div>'; // .history-values
        html += '</div>'; // .history-item
    }

    html += '</div>';
    body.innerHTML = html;
}

function filterHistoryByField() {
    renderHistoryModal();
}

function formatTimestamp(ts) {
    if (!ts) return 'Unknown';
    var date = new Date(ts);
    var now = new Date();
    var diff = now - date;

    // If less than 24 hours, show relative time
    if (diff < 86400000) {
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
        return Math.floor(diff / 3600000) + ' hour' + (Math.floor(diff / 3600000) !== 1 ? 's' : '') + ' ago';
    }

    // Otherwise show date and time
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatHistoryValue(value) {
    if (value === null || value === undefined) {
        return '<span style="color: #999; font-style: italic;">empty</span>';
    }

    if (Array.isArray(value)) {
        if (value.length === 0) return '<span style="color: #999; font-style: italic;">empty array</span>';

        // Check if it's an array of objects
        if (typeof value[0] === 'object' && value[0] !== null) {
            var items = value.map(item => {
                if (item.name) return item.name;
                if (item.filename) return item.filename;
                if (item.email) return item.email;
                if (item.id) return item.id;
                return JSON.stringify(item).slice(0, 30);
            });
            return items.map(i => '<span class="tag" style="background: #e8f0fe; color: #2d6cdf; padding: 2px 8px; border-radius: 12px; margin: 1px 2px 1px 0; display: inline-block;">' + esc(i) + '</span>').join('');
        }

        return value.map(i => '<span class="tag" style="background: #e8f0fe; color: #2d6cdf; padding: 2px 8px; border-radius: 12px; margin: 1px 2px 1px 0; display: inline-block;">' + esc(String(i)) + '</span>').join('');
    }

    if (typeof value === 'object') {
        if (value.name) return esc(value.name);
        if (value.filename) return esc(value.filename);
        if (value.email) return esc(value.email);
        return esc(JSON.stringify(value).slice(0, 100));
    }

    if (typeof value === 'boolean') {
        return '<span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; ' +
            (value ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;') + '">' +
            (value ? 'Yes' : 'No') + '</span>';
    }

    if (typeof value === 'number') {
        return '<span style="font-family: monospace;">' + value.toLocaleString() + '</span>';
    }

    return esc(String(value));
}

// Keyboard handler for modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('history-modal-overlay');
        if (overlay && overlay.classList.contains('open')) {
            closeHistoryModal();
        }
        // Also close view selector and fields dropdown
        closeAllDropdowns();
    }
});

// ============ View Selector & Fields Dropdown UI ============

// Toggle view selector dropdown
function toggleViewSelector() {
    var dropdown = document.getElementById('view-selector-dropdown');
    var fieldsDropdown = document.getElementById('fields-dropdown');

    // Close fields dropdown if open
    fieldsDropdown.classList.remove('open');

    dropdown.classList.toggle('open');
}

// Toggle fields dropdown
function toggleFieldsDropdown() {
    var dropdown = document.getElementById('fields-dropdown');
    var viewDropdown = document.getElementById('view-selector-dropdown');

    // Close view dropdown if open
    viewDropdown.classList.remove('open');

    dropdown.classList.toggle('open');
}

// Close all dropdowns
function closeAllDropdowns() {
    document.getElementById('view-selector-dropdown')?.classList.remove('open');
    document.getElementById('fields-dropdown')?.classList.remove('open');
}

// Click outside handler to close dropdowns
document.addEventListener('click', function(e) {
    var viewSelector = document.getElementById('view-selector-container');
    var fieldsBtn = document.getElementById('fields-btn');
    var fieldsDropdown = document.getElementById('fields-dropdown');

    // Close view selector if clicked outside
    if (viewSelector && !viewSelector.contains(e.target)) {
        document.getElementById('view-selector-dropdown')?.classList.remove('open');
    }

    // Close fields dropdown if clicked outside
    if (fieldsBtn && fieldsDropdown && !fieldsBtn.contains(e.target) && !fieldsDropdown.contains(e.target)) {
        fieldsDropdown.classList.remove('open');
    }
});

// Get view type icon
function getViewTypeIcon(viewType) {
    switch ((viewType || '').toLowerCase()) {
        case 'grid': return '&#9638;';
        case 'gallery': return '&#128444;';
        case 'kanban': return '&#9636;';
        case 'calendar': return '&#128197;';
        case 'timeline': return '&#8594;';
        case 'form': return '&#128196;';
        default: return '&#9638;';
    }
}

// Render view selector dropdown
function renderViewSelector() {
    if (!currentTable) return;

    var dropdown = document.getElementById('view-selector-dropdown');
    var currentViewIcon = document.getElementById('current-view-icon');
    var currentViewName = document.getElementById('current-view-name');

    var views = META_VIEWS[currentTable] || {};
    var viewIds = Object.keys(views);

    // Update current view display
    var viewId = currentView || '_default';
    var currentViewObj = views[viewId];
    if (currentViewObj) {
        currentViewIcon.innerHTML = getViewTypeIcon(currentViewObj.viewType);
        currentViewName.textContent = currentViewObj.viewName || viewId;
    } else {
        currentViewIcon.innerHTML = '&#9638;';
        currentViewName.textContent = 'All Fields';
    }

    // Build dropdown
    var html = '<div class="view-selector-dropdown-header">Views</div>';

    // Add "All Fields" default option
    var isDefaultActive = !currentView || currentView === '_default';
    html += '<div class="view-selector-option' + (isDefaultActive ? ' active' : '') + '" onclick="selectView(\'_default\')">';
    html += '<span class="view-type-icon">&#9638;</span>';
    html += '<span class="view-option-name">All Fields</span>';
    if (isDefaultActive) html += '<span class="view-check">&#10003;</span>';
    html += '</div>';

    // Add existing views
    for (var vid of viewIds) {
        if (vid === '_default') continue;
        var view = views[vid];
        var isActive = currentView === vid;
        html += '<div class="view-selector-option' + (isActive ? ' active' : '') + '" onclick="selectView(\'' + esc(vid) + '\')">';
        html += '<span class="view-type-icon">' + getViewTypeIcon(view.viewType) + '</span>';
        html += '<span class="view-option-name">' + esc(view.viewName || vid) + '</span>';
        if (isActive) html += '<span class="view-check">&#10003;</span>';
        html += '</div>';
    }

    dropdown.innerHTML = html;
}

// Select a view
async function selectView(viewId) {
    currentView = viewId;
    closeAllDropdowns();

    // Update sidebar to reflect the new active view
    if (currentTable) {
        updateSidebarViewActive(currentTable, viewId);
    }

    // Render view selector to update current view display
    renderViewSelector();

    // Render fields dropdown for new view
    renderFieldsDropdown();
    updateFieldsCount();

    // Re-render table with new view's field configuration
    await renderTable();
}

// Render fields dropdown
function renderFieldsDropdown() {
    if (!currentTable) return;

    var list = document.getElementById('fields-dropdown-list');
    var fields = META_FIELDS[currentTable] || {};
    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);
    var visibleSet = new Set(config.visibleFieldIds);

    // Get all fields in order
    var allFieldIds = getAllFieldsInOrder(currentTable, viewId);

    var html = '';
    for (var i = 0; i < allFieldIds.length; i++) {
        var fid = allFieldIds[i];
        var field = fields[fid];
        if (!field) continue;

        var isVisible = visibleSet.has(fid);
        var fieldName = field.fieldName || fid;
        var fieldType = field.fieldType || 'unknown';

        html += '<div class="fields-dropdown-item" data-field-id="' + esc(fid) + '">';

        // Drag handle
        html += '<span class="field-drag-handle" title="Drag to reorder">&#9776;</span>';

        // Checkbox
        html += '<div class="field-checkbox' + (isVisible ? ' checked' : '') + '" onclick="toggleFieldVisibility(\'' + esc(fid) + '\')">';
        html += '<span class="check-icon">&#10003;</span>';
        html += '</div>';

        // Field info
        html += '<div class="field-info" onclick="toggleFieldVisibility(\'' + esc(fid) + '\')">';
        html += '<div class="field-name">' + esc(fieldName) + '</div>';
        html += '<div class="field-type">' + esc(fieldType) + '</div>';
        html += '</div>';

        // Move buttons
        html += '<div class="field-move-btns">';
        if (i > 0) {
            html += '<button class="field-move-btn" onclick="moveFieldUp(\'' + esc(fid) + '\')" title="Move up">&#9650;</button>';
        } else {
            html += '<button class="field-move-btn" disabled style="opacity: 0.3;">&#9650;</button>';
        }
        if (i < allFieldIds.length - 1) {
            html += '<button class="field-move-btn" onclick="moveFieldDown(\'' + esc(fid) + '\')" title="Move down">&#9660;</button>';
        } else {
            html += '<button class="field-move-btn" disabled style="opacity: 0.3;">&#9660;</button>';
        }
        html += '</div>';

        html += '</div>';
    }

    list.innerHTML = html;
}

// Update visible fields count badge
function updateFieldsCount() {
    if (!currentTable) return;

    var viewId = currentView || '_default';
    var config = getViewFieldConfig(currentTable, viewId);
    var fields = META_FIELDS[currentTable] || {};
    var totalFields = Object.keys(fields).length;
    var visibleCount = config.visibleFieldIds.length;

    var countEl = document.getElementById('fields-visible-count');
    if (countEl) {
        countEl.textContent = visibleCount + '/' + totalFields;
    }
}

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============ View Controls (Filter, Sort, Group, etc.) ============

var currentFilters = [];
var currentSorts = [];
var currentGroupBy = null;
var currentColorBy = null;
var currentRowHeight = 'medium';
var currentSearchQuery = '';

// Close all view control dropdowns
function closeViewControlDropdowns() {
    document.querySelectorAll('.view-control-dropdown').forEach(d => d.classList.remove('open'));
}

// Toggle filter dropdown
function toggleFilterDropdown() {
    var dropdown = document.getElementById('filter-dropdown');
    var wasOpen = dropdown.classList.contains('open');
    closeViewControlDropdowns();
    if (!wasOpen) {
        dropdown.classList.add('open');
        renderFilterDropdown();
    }
}

// Toggle sort dropdown
function toggleSortDropdown() {
    var dropdown = document.getElementById('sort-dropdown');
    var wasOpen = dropdown.classList.contains('open');
    closeViewControlDropdowns();
    if (!wasOpen) {
        dropdown.classList.add('open');
        renderSortDropdown();
    }
}

// Toggle group dropdown
function toggleGroupDropdown() {
    var dropdown = document.getElementById('group-dropdown');
    var wasOpen = dropdown.classList.contains('open');
    closeViewControlDropdowns();
    if (!wasOpen) {
        dropdown.classList.add('open');
        renderGroupDropdown();
    }
}

// Toggle color dropdown
function toggleColorDropdown() {
    var dropdown = document.getElementById('color-dropdown');
    var wasOpen = dropdown.classList.contains('open');
    closeViewControlDropdowns();
    if (!wasOpen) {
        dropdown.classList.add('open');
        renderColorDropdown();
    }
}

// Toggle row height dropdown
function toggleRowHeightDropdown() {
    var dropdown = document.getElementById('row-height-dropdown');
    var wasOpen = dropdown.classList.contains('open');
    closeViewControlDropdowns();
    if (!wasOpen) {
        dropdown.classList.add('open');
        updateRowHeightDropdown();
    }
}

// Render filter dropdown
function renderFilterDropdown() {
    if (!currentTable) return;
    var list = document.getElementById('filter-list');

    if (currentFilters.length === 0) {
        list.innerHTML = '<div class="empty-filters">No filters applied</div>';
        return;
    }

    var fields = META_FIELDS[currentTable] || {};
    var html = '';

    for (var i = 0; i < currentFilters.length; i++) {
        var filter = currentFilters[i];
        html += '<div class="filter-row">';
        html += '<select onchange="updateFilter(' + i + ', \'field\', this.value)">';
        for (var fid in fields) {
            var sel = filter.fieldId === fid ? ' selected' : '';
            html += '<option value="' + esc(fid) + '"' + sel + '>' + esc(fields[fid].fieldName || fid) + '</option>';
        }
        html += '</select>';
        html += '<select onchange="updateFilter(' + i + ', \'operator\', this.value)">';
        html += '<option value="contains"' + (filter.operator === 'contains' ? ' selected' : '') + '>contains</option>';
        html += '<option value="equals"' + (filter.operator === 'equals' ? ' selected' : '') + '>equals</option>';
        html += '<option value="not_equals"' + (filter.operator === 'not_equals' ? ' selected' : '') + '>does not equal</option>';
        html += '<option value="is_empty"' + (filter.operator === 'is_empty' ? ' selected' : '') + '>is empty</option>';
        html += '<option value="is_not_empty"' + (filter.operator === 'is_not_empty' ? ' selected' : '') + '>is not empty</option>';
        html += '</select>';
        if (filter.operator !== 'is_empty' && filter.operator !== 'is_not_empty') {
            html += '<input type="text" value="' + esc(filter.value || '') + '" onchange="updateFilter(' + i + ', \'value\', this.value)" placeholder="Value">';
        }
        html += '<button class="filter-remove-btn" onclick="removeFilter(' + i + ')" title="Remove">&times;</button>';
        html += '</div>';
    }

    list.innerHTML = html;
    updateFilterCount();
}

// Add filter
function addFilter() {
    if (!currentTable) return;
    var fields = META_FIELDS[currentTable] || {};
    var firstFieldId = Object.keys(fields)[0];
    if (!firstFieldId) return;

    currentFilters.push({
        fieldId: firstFieldId,
        operator: 'contains',
        value: ''
    });
    renderFilterDropdown();
    applyFilters();
}

// Update filter
function updateFilter(index, prop, value) {
    if (currentFilters[index]) {
        currentFilters[index][prop] = value;
        renderFilterDropdown();
        applyFilters();
    }
}

// Remove filter
function removeFilter(index) {
    currentFilters.splice(index, 1);
    renderFilterDropdown();
    applyFilters();
}

// Update filter count badge
function updateFilterCount() {
    var countEl = document.getElementById('filter-count');
    var btn = document.getElementById('filter-btn');
    if (currentFilters.length > 0) {
        countEl.textContent = currentFilters.length;
        countEl.style.display = 'inline-block';
        btn.classList.add('active');
    } else {
        countEl.style.display = 'none';
        btn.classList.remove('active');
    }
}

// Apply filters (re-render table)
async function applyFilters() {
    updateFilterCount();
    await renderTable();
}

// Render sort dropdown
function renderSortDropdown() {
    if (!currentTable) return;
    var list = document.getElementById('sort-list');

    if (currentSorts.length === 0) {
        list.innerHTML = '<div class="empty-sorts">No sorts applied</div>';
        return;
    }

    var fields = META_FIELDS[currentTable] || {};
    var html = '';

    for (var i = 0; i < currentSorts.length; i++) {
        var sort = currentSorts[i];
        html += '<div class="sort-row">';
        html += '<select onchange="updateSort(' + i + ', \'field\', this.value)">';
        for (var fid in fields) {
            var sel = sort.fieldId === fid ? ' selected' : '';
            html += '<option value="' + esc(fid) + '"' + sel + '>' + esc(fields[fid].fieldName || fid) + '</option>';
        }
        html += '</select>';
        html += '<div class="sort-direction-btns">';
        html += '<button class="sort-direction-btn' + (sort.direction === 'asc' ? ' active' : '') + '" onclick="updateSort(' + i + ', \'direction\', \'asc\')">Aâ†’Z</button>';
        html += '<button class="sort-direction-btn' + (sort.direction === 'desc' ? ' active' : '') + '" onclick="updateSort(' + i + ', \'direction\', \'desc\')">Zâ†’A</button>';
        html += '</div>';
        html += '<button class="sort-remove-btn" onclick="removeSort(' + i + ')" title="Remove">&times;</button>';
        html += '</div>';
    }

    list.innerHTML = html;
    updateSortCount();
}

// Add sort
function addSort() {
    if (!currentTable) return;
    var fields = META_FIELDS[currentTable] || {};
    var firstFieldId = Object.keys(fields)[0];
    if (!firstFieldId) return;

    currentSorts.push({
        fieldId: firstFieldId,
        direction: 'asc'
    });
    renderSortDropdown();
    applySorts();
}

// Update sort
function updateSort(index, prop, value) {
    if (currentSorts[index]) {
        currentSorts[index][prop] = value;
        renderSortDropdown();
        applySorts();
    }
}

// Remove sort
function removeSort(index) {
    currentSorts.splice(index, 1);
    renderSortDropdown();
    applySorts();
}

// Update sort count badge
function updateSortCount() {
    var countEl = document.getElementById('sort-count');
    var btn = document.getElementById('sort-btn');
    if (currentSorts.length > 0) {
        countEl.textContent = currentSorts.length;
        countEl.style.display = 'inline-block';
        btn.classList.add('active');
    } else {
        countEl.style.display = 'none';
        btn.classList.remove('active');
    }
}

// Apply sorts (re-render table)
async function applySorts() {
    updateSortCount();
    await renderTable();
}

// Render group dropdown
function renderGroupDropdown() {
    if (!currentTable) return;
    var container = document.getElementById('group-options');
    var fields = META_FIELDS[currentTable] || {};

    var html = '<div class="group-option' + (!currentGroupBy ? ' none-selected' : '') + '" onclick="setGroupBy(null)">';
    html += '<span class="check-mark">&#10003;</span>';
    html += '<span>None</span>';
    html += '</div>';

    for (var fid in fields) {
        var field = fields[fid];
        var isSelected = currentGroupBy === fid;
        html += '<div class="group-option' + (isSelected ? ' selected' : '') + '" onclick="setGroupBy(\'' + esc(fid) + '\')">';
        html += '<span class="check-mark">&#10003;</span>';
        html += '<span>' + esc(field.fieldName || fid) + '</span>';
        html += '</div>';
    }

    container.innerHTML = html;
}

// Set group by field
async function setGroupBy(fieldId) {
    currentGroupBy = fieldId;
    closeViewControlDropdowns();
    var btn = document.getElementById('group-btn');
    if (fieldId) {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
    }
    await renderTable();
}

// Render color dropdown
function renderColorDropdown() {
    if (!currentTable) return;
    var container = document.getElementById('color-options');
    var fields = META_FIELDS[currentTable] || {};

    var html = '<div class="color-option' + (!currentColorBy ? ' none-selected' : '') + '" onclick="setColorBy(null)">';
    html += '<span class="check-mark">&#10003;</span>';
    html += '<span>None</span>';
    html += '</div>';

    for (var fid in fields) {
        var field = fields[fid];
        var isSelected = currentColorBy === fid;
        html += '<div class="color-option' + (isSelected ? ' selected' : '') + '" onclick="setColorBy(\'' + esc(fid) + '\')">';
        html += '<span class="check-mark">&#10003;</span>';
        html += '<span>' + esc(field.fieldName || fid) + '</span>';
        html += '</div>';
    }

    container.innerHTML = html;
}

// Set color by field
async function setColorBy(fieldId) {
    currentColorBy = fieldId;
    closeViewControlDropdowns();
    var btn = document.getElementById('color-btn');
    if (fieldId) {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
    }
    await renderTable();
}

// Update row height dropdown selection
function updateRowHeightDropdown() {
    document.querySelectorAll('.row-height-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    var options = document.querySelectorAll('.row-height-option');
    options.forEach(opt => {
        if (opt.textContent.trim().toLowerCase().replace(' ', '-') === currentRowHeight ||
            (opt.textContent.trim() === 'Short' && currentRowHeight === 'short') ||
            (opt.textContent.trim() === 'Medium' && currentRowHeight === 'medium') ||
            (opt.textContent.trim() === 'Tall' && currentRowHeight === 'tall') ||
            (opt.textContent.trim() === 'Extra tall' && currentRowHeight === 'extra-tall')) {
            opt.classList.add('selected');
        }
    });
}

// Set row height
function setRowHeight(height) {
    currentRowHeight = height;
    closeViewControlDropdowns();

    var table = document.getElementById('table');
    if (table) {
        table.className = 'row-height-' + height;
    }
}

// Handle view search
function handleViewSearch(query) {
    currentSearchQuery = query.toLowerCase();
    renderTable();
}

// Update closeAllDropdowns to also close view control dropdowns
var originalCloseAllDropdowns = closeAllDropdowns;
closeAllDropdowns = function() {
    originalCloseAllDropdowns();
    closeViewControlDropdowns();
};

// Add click handler for view control dropdowns
document.addEventListener('click', function(e) {
    var wrapper = e.target.closest('.view-control-wrapper');
    if (!wrapper) {
        closeViewControlDropdowns();
    }
});

initAuthScreen();
    </script>
</body>
</html>
