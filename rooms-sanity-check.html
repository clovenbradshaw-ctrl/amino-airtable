<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amino — Rooms Sanity Check</title>
<style>
    :root {
        --bg: #0d1117;
        --surface: #161b22;
        --surface2: #1c2128;
        --border: #30363d;
        --text: #e6edf3;
        --text-muted: #8b949e;
        --accent: #58a6ff;
        --green: #3fb950;
        --yellow: #d29922;
        --red: #f85149;
        --purple: #bc8cff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        background: var(--bg);
        color: var(--text);
        padding: 24px;
        line-height: 1.5;
    }
    h1 { font-size: 20px; margin-bottom: 4px; }
    h2 { font-size: 16px; color: var(--accent); margin: 20px 0 10px; }
    h3 { font-size: 14px; color: var(--purple); margin: 12px 0 6px; }
    .subtitle { color: var(--text-muted); font-size: 12px; margin-bottom: 20px; }
    .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    input[type="text"], input[type="password"] {
        width: 100%;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px 10px;
        color: var(--text);
        font-family: inherit;
        font-size: 13px;
        margin-bottom: 10px;
    }
    input:focus { outline: none; border-color: var(--accent); }
    button {
        background: var(--accent);
        color: var(--bg);
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        font-family: inherit;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    button.secondary {
        background: var(--surface2);
        color: var(--text);
        border: 1px solid var(--border);
    }
    .btn-row { display: flex; gap: 8px; margin-top: 8px; }
    .status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }
    .status-ok { background: rgba(63, 185, 80, 0.15); color: var(--green); }
    .status-warn { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
    .status-err { background: rgba(248, 81, 73, 0.15); color: var(--red); }
    .status-info { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 8px;
    }
    th {
        text-align: left;
        padding: 6px 10px;
        border-bottom: 1px solid var(--border);
        color: var(--text-muted);
        font-weight: 600;
        white-space: nowrap;
    }
    td {
        padding: 6px 10px;
        border-bottom: 1px solid var(--border);
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    tr:hover td { background: var(--surface2); }
    .mono { font-family: inherit; font-size: 11px; color: var(--text-muted); }
    .room-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
    }
    .room-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .room-card-title { font-weight: 600; font-size: 13px; }
    .room-card-id { font-size: 11px; color: var(--text-muted); }
    .room-card-stats {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--text-muted);
    }
    .room-card-stats span strong { color: var(--text); }
    .collapsible { cursor: pointer; user-select: none; }
    .collapsible::before { content: '\25B6 '; font-size: 10px; }
    .collapsible.open::before { content: '\25BC '; }
    .collapse-content { display: none; margin-top: 8px; }
    .collapse-content.show { display: block; }
    pre.json {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 10px;
        font-size: 11px;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .log-area {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 10px;
        font-size: 11px;
        max-height: 200px;
        overflow-y: auto;
    }
    .log-line { margin-bottom: 2px; }
    .log-line.info { color: var(--accent); }
    .log-line.ok { color: var(--green); }
    .log-line.warn { color: var(--yellow); }
    .log-line.err { color: var(--red); }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .summary-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        text-align: center;
    }
    .summary-card .number {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
    }
    .summary-card .label {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
    }
    #results { display: none; }
    .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .tab-bar { display: flex; gap: 4px; margin-bottom: 12px; }
    .tab {
        padding: 6px 14px;
        font-size: 12px;
        font-family: inherit;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--surface);
        color: var(--text-muted);
        cursor: pointer;
    }
    .tab.active {
        background: var(--accent);
        color: var(--bg);
        border-color: var(--accent);
        font-weight: 600;
    }
</style>
</head>
<body>

<h1>Rooms Sanity Check</h1>
<p class="subtitle">Inspect Matrix rooms, table mappings, and stored data for the Amino system.</p>

<!-- Login Panel -->
<div class="panel" id="login-panel">
    <h2>Connect</h2>
    <label for="hs-url">Homeserver URL</label>
    <input type="text" id="hs-url" value="https://app.aminoimmigration.com" placeholder="https://matrix.example.com">
    <label for="username">Username</label>
    <input type="text" id="username" placeholder="admin">
    <label for="password">Password</label>
    <input type="password" id="password" placeholder="password">
    <div class="btn-row">
        <button id="btn-login" onclick="doLogin()">Login &amp; Run Check</button>
        <button class="secondary" id="btn-restore" onclick="doRestore()">Restore Session</button>
    </div>
    <div class="log-area" id="login-log" style="margin-top: 10px;"></div>
</div>

<!-- Results -->
<div id="results">
    <div class="panel" id="session-info"></div>

    <!-- Tabs -->
    <div class="tab-bar">
        <div class="tab active" onclick="showTab('overview')">Overview</div>
        <div class="tab" onclick="showTab('rooms')">All Rooms</div>
        <div class="tab" onclick="showTab('table-rooms')">Table Rooms</div>
        <div class="tab" onclick="showTab('data')">Stored Data</div>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content">
        <div class="panel">
            <h2>Summary</h2>
            <div class="summary-grid" id="summary-grid"></div>
        </div>
        <div class="panel">
            <h2>Table-Room Mapping</h2>
            <div id="table-room-map"></div>
        </div>
    </div>

    <!-- All Rooms Tab -->
    <div id="tab-rooms" class="tab-content hidden">
        <div class="panel">
            <h2>Joined Rooms</h2>
            <div id="rooms-list"></div>
        </div>
    </div>

    <!-- Table Rooms Tab -->
    <div id="tab-table-rooms" class="tab-content hidden">
        <div class="panel">
            <h2>Table Rooms Detail</h2>
            <p class="subtitle" style="margin-bottom: 12px;">Rooms mapped to Airtable tables with recent event data.</p>
            <div id="table-rooms-detail"></div>
        </div>
    </div>

    <!-- Stored Data Tab -->
    <div id="tab-data" class="tab-content hidden">
        <div class="panel">
            <h2>IndexedDB Records</h2>
            <p class="subtitle" style="margin-bottom: 12px;">Decrypted records stored locally per table.</p>
            <div id="idb-data"></div>
        </div>
    </div>
</div>

<!-- Load the project modules -->
<script src="matrix.js"></script>
<script src="data-layer.js"></script>

<script>
(function() {
    'use strict';

    // ============ Logging ============
    var logEl = null;
    function log(msg, level) {
        level = level || 'info';
        if (!logEl) logEl = document.getElementById('login-log');
        var line = document.createElement('div');
        line.className = 'log-line ' + level;
        line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // ============ Tab Navigation ============
    window.showTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(function(el) {
            el.classList.add('hidden');
        });
        document.querySelectorAll('.tab').forEach(function(el) {
            el.classList.remove('active');
        });
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        // Mark active tab
        var tabs = document.querySelectorAll('.tab');
        var tabNames = ['overview', 'rooms', 'table-rooms', 'data'];
        for (var i = 0; i < tabNames.length; i++) {
            if (tabNames[i] === tabName) tabs[i].classList.add('active');
        }
    };

    // ============ Collapsible Sections ============
    window.toggleCollapse = function(id) {
        var el = document.getElementById(id);
        var trigger = el.previousElementSibling;
        el.classList.toggle('show');
        trigger.classList.toggle('open');
    };

    // ============ Login ============
    window.doLogin = async function() {
        var hsUrl = document.getElementById('hs-url').value.trim().replace(/\/$/, '');
        var username = document.getElementById('username').value.trim();
        var password = document.getElementById('password').value;

        if (!hsUrl || !username || !password) {
            log('All fields are required.', 'err');
            return;
        }

        var btn = document.getElementById('btn-login');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Connecting...';

        try {
            log('Logging into Matrix at ' + hsUrl + '...');
            var session = await MatrixClient.login(hsUrl, username, password);
            log('Logged in as ' + session.userId, 'ok');

            log('Initializing data layer (deriving encryption key)...');
            await AminoData.init(session.accessToken, session.userId, password);
            log('Data layer initialized with ' + AminoData.getTableIds().length + ' tables', 'ok');

            log('Running initial sync to populate room cache...');
            await MatrixClient.initialSync();
            log('Sync complete. Joined rooms: ' + MatrixClient.getJoinedRooms().length, 'ok');

            log('Running sanity check...');
            await runSanityCheck(password);
        } catch (err) {
            log('Error: ' + err.message, 'err');
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Login & Run Check';
        }
    };

    window.doRestore = async function() {
        var btn = document.getElementById('btn-restore');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Restoring...';

        try {
            var restored = MatrixClient.restoreSession();
            if (!restored) {
                log('No saved session found. Please log in.', 'warn');
                return;
            }
            log('Session restored for ' + MatrixClient.getUserId(), 'ok');

            // Still need password for encryption key
            var password = document.getElementById('password').value;
            if (!password) {
                log('Password required to derive encryption key (enter it above).', 'warn');
                return;
            }

            log('Initializing data layer...');
            await AminoData.init(MatrixClient.getAccessToken(), MatrixClient.getUserId(), password);
            log('Data layer initialized with ' + AminoData.getTableIds().length + ' tables', 'ok');

            log('Running initial sync...');
            await MatrixClient.initialSync();
            log('Sync complete. Joined rooms: ' + MatrixClient.getJoinedRooms().length, 'ok');

            log('Running sanity check...');
            await runSanityCheck(password);
        } catch (err) {
            log('Error: ' + err.message, 'err');
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Restore Session';
        }
    };

    // ============ Sanity Check ============
    async function runSanityCheck(password) {
        document.getElementById('results').style.display = 'block';

        var userId = MatrixClient.getUserId();
        var hsUrl = MatrixClient.getHomeserverUrl();
        var joinedRoomIds = MatrixClient.getJoinedRooms();
        var tableRoomMap = AminoData.getTableRoomMap();
        var tables = AminoData.getTableList();
        var tableIds = AminoData.getTableIds();

        // Reverse map: roomId -> tableId
        var roomTableMap = {};
        Object.keys(tableRoomMap).forEach(function(tId) {
            roomTableMap[tableRoomMap[tId]] = tId;
        });

        // ---- Session Info ----
        document.getElementById('session-info').innerHTML =
            '<strong>Session:</strong> ' + esc(userId) +
            ' &nbsp; <span class="status status-ok">Connected</span>' +
            ' &nbsp; <span class="mono">' + esc(hsUrl) + '</span>';

        // ---- Classify rooms ----
        var spaces = [];
        var tableRooms = [];
        var otherRooms = [];

        for (var i = 0; i < joinedRoomIds.length; i++) {
            var rId = joinedRoomIds[i];
            var rName = MatrixClient.getRoomName(rId);
            var isSp = MatrixClient.isSpace(rId);
            var mappedTable = roomTableMap[rId] || null;

            var info = {
                roomId: rId,
                name: rName,
                isSpace: isSp,
                mappedTableId: mappedTable,
                mappedTableName: null
            };

            if (mappedTable) {
                for (var t = 0; t < tables.length; t++) {
                    if (tables[t].table_id === mappedTable) {
                        info.mappedTableName = tables[t].table_name;
                        break;
                    }
                }
            }

            if (isSp) spaces.push(info);
            else if (mappedTable) tableRooms.push(info);
            else otherRooms.push(info);
        }

        // ---- Summary Grid ----
        var summaryHtml = '';
        summaryHtml += summaryCard(joinedRoomIds.length, 'Total Rooms');
        summaryHtml += summaryCard(spaces.length, 'Spaces');
        summaryHtml += summaryCard(tableRooms.length, 'Table Rooms');
        summaryHtml += summaryCard(otherRooms.length, 'Other Rooms');
        summaryHtml += summaryCard(tables.length, 'Registered Tables');
        summaryHtml += summaryCard(Object.keys(tableRoomMap).length, 'Table-Room Mappings');
        document.getElementById('summary-grid').innerHTML = summaryHtml;

        // ---- Table-Room Mapping ----
        var mapHtml = '<table><tr><th>Table Name</th><th>Table ID</th><th>Room ID</th><th>Status</th></tr>';
        for (var m = 0; m < tables.length; m++) {
            var tbl = tables[m];
            var roomId = tableRoomMap[tbl.table_id];
            var inJoined = roomId ? joinedRoomIds.indexOf(roomId) !== -1 : false;
            var statusHtml = '';
            if (!roomId) {
                statusHtml = '<span class="status status-err">No Room</span>';
            } else if (inJoined) {
                statusHtml = '<span class="status status-ok">Joined</span>';
            } else {
                statusHtml = '<span class="status status-warn">Not Joined</span>';
            }
            mapHtml += '<tr><td>' + esc(tbl.table_name || '—') + '</td>' +
                '<td class="mono">' + esc(tbl.table_id) + '</td>' +
                '<td class="mono">' + esc(roomId || '—') + '</td>' +
                '<td>' + statusHtml + '</td></tr>';
        }
        mapHtml += '</table>';
        document.getElementById('table-room-map').innerHTML = mapHtml;

        // ---- All Rooms List ----
        var roomsHtml = '';
        var allRooms = spaces.concat(tableRooms).concat(otherRooms);
        for (var r = 0; r < allRooms.length; r++) {
            var rm = allRooms[r];
            var typeLabel = rm.isSpace ? '<span class="status status-info">Space</span>' :
                rm.mappedTableId ? '<span class="status status-ok">Table</span>' :
                '<span class="status status-warn">Other</span>';
            var extra = rm.mappedTableName ? ' &rarr; ' + esc(rm.mappedTableName) : '';
            roomsHtml += '<div class="room-card">' +
                '<div class="room-card-header">' +
                '<span class="room-card-title">' + esc(rm.name) + ' ' + typeLabel + extra + '</span>' +
                '</div>' +
                '<div class="room-card-id">' + esc(rm.roomId) + '</div>' +
                '</div>';
        }
        document.getElementById('rooms-list').innerHTML = roomsHtml || '<p class="mono">No rooms found.</p>';

        // ---- Table Rooms Detail (with events) ----
        log('Fetching room data for ' + tableRooms.length + ' table rooms...');
        var detailHtml = '';
        for (var d = 0; d < tableRooms.length; d++) {
            var tr = tableRooms[d];
            detailHtml += await buildTableRoomDetail(tr, d);
        }
        document.getElementById('table-rooms-detail').innerHTML = detailHtml || '<p class="mono">No table rooms found.</p>';
        log('Table room details loaded.', 'ok');

        // ---- IndexedDB Stored Data ----
        log('Reading stored records from IndexedDB...');
        var dataHtml = '';
        var totalRecords = 0;
        for (var s = 0; s < tableIds.length; s++) {
            var tId = tableIds[s];
            var tName = '—';
            for (var tn = 0; tn < tables.length; tn++) {
                if (tables[tn].table_id === tId) { tName = tables[tn].table_name; break; }
            }
            try {
                var records = await AminoData.getTableRecords(tId);
                totalRecords += records.length;
                var collapseId = 'idb-' + s;
                dataHtml += '<div class="room-card">';
                dataHtml += '<div class="room-card-header">';
                dataHtml += '<span class="room-card-title">' + esc(tName) + '</span>';
                dataHtml += '<span class="status status-info">' + records.length + ' records</span>';
                dataHtml += '</div>';
                dataHtml += '<div class="room-card-id">' + esc(tId) + '</div>';

                if (records.length > 0) {
                    dataHtml += '<h3 class="collapsible" onclick="toggleCollapse(\'' + collapseId + '\')">Sample Records (first 5)</h3>';
                    dataHtml += '<div class="collapse-content" id="' + collapseId + '">';

                    // Show up to 5 records
                    var sample = records.slice(0, 5);
                    for (var sr = 0; sr < sample.length; sr++) {
                        dataHtml += '<div style="margin-bottom: 8px;">';
                        dataHtml += '<strong class="mono">' + esc(sample[sr].id) + '</strong>';
                        dataHtml += '<pre class="json">' + esc(JSON.stringify(sample[sr].fields, null, 2)) + '</pre>';
                        dataHtml += '</div>';
                    }
                    if (records.length > 5) {
                        dataHtml += '<p class="mono" style="color:var(--text-muted);">... and ' + (records.length - 5) + ' more records</p>';
                    }
                    dataHtml += '</div>';
                }
                dataHtml += '</div>';
            } catch (err) {
                dataHtml += '<div class="room-card">';
                dataHtml += '<div class="room-card-header">';
                dataHtml += '<span class="room-card-title">' + esc(tName) + '</span>';
                dataHtml += '<span class="status status-err">Error</span>';
                dataHtml += '</div>';
                dataHtml += '<p class="mono" style="color:var(--red);">' + esc(err.message) + '</p>';
                dataHtml += '</div>';
            }
        }

        // Update the summary with total IDB records
        summaryHtml += summaryCard(totalRecords, 'IndexedDB Records');
        document.getElementById('summary-grid').innerHTML = summaryHtml;

        document.getElementById('idb-data').innerHTML = dataHtml || '<p class="mono">No data in IndexedDB. Run hydration first.</p>';
        log('Sanity check complete. ' + totalRecords + ' total records in IndexedDB.', 'ok');
    }

    // ---- Build detail card for a single table room ----
    async function buildTableRoomDetail(roomInfo, idx) {
        var html = '<div class="room-card">';
        html += '<div class="room-card-header">';
        html += '<span class="room-card-title">' + esc(roomInfo.name) + '</span>';
        html += '<span class="status status-ok">' + esc(roomInfo.mappedTableName || roomInfo.mappedTableId) + '</span>';
        html += '</div>';
        html += '<div class="room-card-id">' + esc(roomInfo.roomId) + '</div>';

        // Fetch state events for the room
        try {
            var state = await MatrixClient.getRoomState(roomInfo.roomId);

            // Classify state events
            var stateByType = {};
            for (var i = 0; i < state.length; i++) {
                var evtType = state[i].type;
                if (!stateByType[evtType]) stateByType[evtType] = [];
                stateByType[evtType].push(state[i]);
            }

            html += '<div class="room-card-stats" style="margin-top: 8px;">';
            html += '<span>State events: <strong>' + state.length + '</strong></span>';
            var types = Object.keys(stateByType);
            for (var t = 0; t < types.length; t++) {
                html += '<span>' + esc(types[t].replace('law.firm.', '')) + ': <strong>' + stateByType[types[t]].length + '</strong></span>';
            }
            html += '</div>';

            // Show state event summary
            var stateCollapseId = 'state-' + idx;
            html += '<h3 class="collapsible" onclick="toggleCollapse(\'' + stateCollapseId + '\')">State Events</h3>';
            html += '<div class="collapse-content" id="' + stateCollapseId + '">';
            html += '<table><tr><th>Type</th><th>State Key</th><th>Content (truncated)</th></tr>';
            for (var s = 0; s < state.length; s++) {
                var evt = state[s];
                var contentStr = JSON.stringify(evt.content);
                if (contentStr.length > 120) contentStr = contentStr.substring(0, 120) + '...';
                html += '<tr><td class="mono">' + esc(evt.type) + '</td>' +
                    '<td class="mono">' + esc(evt.state_key || '—') + '</td>' +
                    '<td class="mono">' + esc(contentStr) + '</td></tr>';
            }
            html += '</table></div>';
        } catch (err) {
            html += '<p class="mono" style="color:var(--yellow); margin-top: 8px;">Could not fetch state: ' + esc(err.message) + '</p>';
        }

        // Fetch recent timeline events (last 20 mutations)
        try {
            var messages = await MatrixClient.getRoomMessages(roomInfo.roomId, {
                dir: 'b',
                limit: 20,
                filter: { types: ['law.firm.record.mutate', 'law.firm.schema.object'] }
            });

            var chunk = (messages && messages.chunk) || [];
            var timelineCollapseId = 'timeline-' + idx;
            html += '<h3 class="collapsible" onclick="toggleCollapse(\'' + timelineCollapseId + '\')">Recent Events (' + chunk.length + ')</h3>';
            html += '<div class="collapse-content" id="' + timelineCollapseId + '">';

            if (chunk.length > 0) {
                html += '<table><tr><th>Time</th><th>Type</th><th>Record ID</th><th>Encrypted</th><th>Sender</th></tr>';
                for (var e = 0; e < chunk.length; e++) {
                    var ev = chunk[e];
                    var ts = ev.origin_server_ts ? new Date(ev.origin_server_ts).toLocaleString() : '—';
                    var recId = (ev.content && ev.content.recordId) || '—';
                    var isEnc = (ev.content && ev.content._encrypted) ? 'Yes' : 'No';
                    html += '<tr><td class="mono">' + esc(ts) + '</td>' +
                        '<td class="mono">' + esc(ev.type.replace('law.firm.', '')) + '</td>' +
                        '<td class="mono">' + esc(recId) + '</td>' +
                        '<td>' + (isEnc === 'Yes' ? '<span class="status status-info">Encrypted</span>' : '<span class="status status-warn">Plain</span>') + '</td>' +
                        '<td class="mono">' + esc(ev.sender || '—') + '</td></tr>';
                }
                html += '</table>';
            } else {
                html += '<p class="mono" style="color:var(--text-muted);">No mutation events found in this room.</p>';
            }
            html += '</div>';
        } catch (err) {
            html += '<p class="mono" style="color:var(--yellow); margin-top: 8px;">Could not fetch timeline: ' + esc(err.message) + '</p>';
        }

        html += '</div>';
        return html;
    }

    // ---- Helpers ----
    function summaryCard(number, label) {
        return '<div class="summary-card"><div class="number">' + number + '</div><div class="label">' + esc(label) + '</div></div>';
    }

    function esc(str) {
        if (str === null || str === undefined) return '';
        var div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
    }
})();
</script>

</body>
</html>
