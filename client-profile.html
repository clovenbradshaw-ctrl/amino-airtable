<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amino Client Profile</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --line: #d7e0ea;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-2: #1d4ed8;
      --pill: #eef2f7;
      --success: #0f766e;
      --topbar-bg: #1e293b;
      --topbar-border: #334155;
      --topbar-text: #f8fafc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .topbar {
      display: flex;
      gap: 12px;
      padding: 12px 18px;
      background: var(--topbar-bg);
      border-bottom: 1px solid var(--topbar-border);
      position: sticky;
      top: 0;
      z-index: 10;
      align-items: center;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--topbar-text);
      font-weight: 700;
      letter-spacing: .02em;
      margin-right: 4px;
    }
    .brand-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }
    .nav-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .nav-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 9px;
      padding: 8px 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      color: var(--topbar-text);
      font-size: 13px;
      transition: background .15s ease;
    }
    .nav-btn:hover { background: rgba(255, 255, 255, 0.16); }
    .page {
      padding: 12px 18px 26px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .title-card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 10px;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .title-main h1 {
      margin: 0;
      font-size: 28px;
    }
    .meta { color: var(--muted); font-size: 13px; }
    .summary-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .summary-card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 10px;
      padding: 12px;
    }
    .summary-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .03em; }
    .summary-value { font-weight: 700; margin-top: 4px; }
    .btn {
      background: var(--accent);
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:hover { background: var(--accent-2); }
    .btn.secondary {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab-strip {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
    }
    .tab {
      padding: 9px 11px;
      font-size: 13px;
      cursor: pointer;
      color: #4b5563;
      border-bottom: 2px solid transparent;
      border-radius: 6px 6px 0 0;
    }
    .tab.active {
      color: var(--text);
      background: #fff;
      border: 1px solid var(--line);
      border-bottom: 2px solid var(--accent);
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }
    .panel {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 10px;
      overflow: hidden;
    }
    .panel h3 {
      margin: 0;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 18px;
    }
    .panel-body { padding: 10px 12px; }
    .kv {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 8px;
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px dashed #edf0f4;
    }
    .kv .key { color: #4b5563; }
    .muted { color: var(--muted); }
    .record-pill {
      display: inline-block;
      font-size: 12px;
      color: #374151;
      background: var(--pill);
      border: 1px solid #d7dfe8;
      padding: 2px 8px;
      border-radius: 999px;
      margin: 2px 6px 2px 0;
      vertical-align: middle;
    }
    .record-pill.good {
      color: #0f5132;
      border-color: #8fd3b2;
      background: #ecfdf3;
    }
    .list { display: grid; gap: 10px; }
    .card {
      border: 1px solid #e3e9ef;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    .card-head {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 7px;
      align-items: center;
    }
    .card-title { font-weight: 700; }
    .links a {
      color: #245aa9;
      text-decoration: none;
      font-size: 12px;
      margin-right: 8px;
    }
    .pill-group { margin-top: 7px; }
    .schema-drawer {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8fafc;
      display: none;
      padding: 10px;
    }
    .schema-drawer.open { display: block; }
    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .status.success { color: var(--success); }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .summary-row { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px) {
      .summary-row { grid-template-columns: 1fr; }
      .kv { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><span class="brand-dot"></span>Amino</div>
    <div class="nav-group">
      <a class="nav-btn" href="./Home.html">Home</a>
      <a class="nav-btn" href="./index.html">Clients</a>
      <a class="nav-btn" href="./Events.html">Calendar</a>
      <button class="nav-btn" type="button">Communications</button>
      <button class="nav-btn" type="button">New Client Event</button>
      <button class="nav-btn" type="button">New Case Note</button>
    </div>
  </div>

  <div class="page">
    <div class="title-card">
      <div class="title-main">
        <h1 id="clientName">Client</h1>
        <div class="meta" id="clientMeta">recordId: -</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="adminToggle">Admin: Off</button>
        <button class="btn secondary" id="schemaToggle">Schema Editor</button>
      </div>
    </div>

    <div class="summary-row" id="summaryRow"></div>
    <div class="tab-strip" id="tabStrip"></div>
    <div id="tabContent"></div>

    <div class="schema-drawer" id="schemaDrawer" data-open="false">
      <div class="toolbar">
        <button class="btn" id="saveSchema">Save Schema</button>
        <button class="btn secondary" id="resetSchema">Reset Default</button>
      </div>
      <textarea id="schemaJson"></textarea>
      <div class="status" id="schemaStatus"></div>
    </div>
  </div>

  <script src="./data-layer.js"></script>
  <script>
    const STORAGE_KEYS = {
      schema: 'amino.clientProfile.schema.v1',
      admin: 'amino.clientProfile.admin',
      context: 'amino.clientProfile.context.v1'
    };

    const defaultSchema = {
      tabs: [
        { id: 'client-info', label: 'Client Info', sections: [{ type: 'fields', tableId: 'Clients', title: 'Overview', fields: ['First Name', 'Last Name', 'Office', 'Client Tags', 'Entry Status', 'Case Manager'] }, { type: 'related-list', tableId: 'Addresses', title: 'Addresses', fields: ['Address', 'Address Change Date', 'Same Address Confirmed Date'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }] },
        { id: 'at-a-glance', label: 'At-a-glance', sections: [{ type: 'fields', tableId: 'Clients', title: 'At-a-glance', fields: ['SIJ Case Status', 'Merits Atty', 'Current Stage', 'Priority', 'Notes'] }] },
        { id: 'matters', label: 'Matters', sections: [{ type: 'related-list', tableId: 'Matters', title: 'Matters', fields: ['Matter', 'Description', 'Status', 'Created_By'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }, { type: 'related-list', tableId: 'Matter Notes', title: 'Matter Notes', fields: ['Matter', 'Description', 'Activity', 'Date', 'Created_By'], foreignKeys: ['Client', 'Client Record ID', 'clientId', 'Matter Record ID'] }] },
        { id: 'case-notes', label: 'Case Notes', sections: [{ type: 'related-list', tableId: 'Case Notes', title: 'Case Notes', fields: ['Case Note', 'Category', 'Created', 'Created_By'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }] },
        { id: 'ead', label: 'EAD', sections: [{ type: 'related-list', tableId: 'EAD', title: 'EAD', fields: ['Mail Tracking # EAD', 'EAD Stage', 'EAD Received', 'EAD Sent Date', 'EAD Approval Date'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }] },
        { id: 'all-activities', label: 'All Activities', sections: [{ type: 'related-list', tableId: 'Activities', title: 'All Activity Notes', fields: ['Activity', 'Description', 'Date', 'Owner'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }, { type: 'related-list', tableId: 'Hearings/Interviews', title: 'Hearings/Interviews', fields: ['Event', 'Date', 'Judge', 'Location'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }] },
        { id: 'comms', label: 'Comms', sections: [{ type: 'related-list', tableId: 'Communications', title: 'Communications', fields: ['Type', 'Date', 'Summary', 'Direction'], foreignKeys: ['Client', 'Client Record ID', 'clientId'] }] }
      ]
    };

    const state = {
      schema: loadSchema(),
      admin: loadAdmin(),
      activeTab: null,
      data: {},
      clientId: new URLSearchParams(location.search).get('clientId') || 'recClient001',
      clientRecord: null
    };

    function getClientContextSnapshot() {
      try {
        const raw = sessionStorage.getItem(STORAGE_KEYS.context);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        if (parsed.clientId && parsed.clientId !== state.clientId) return null;
        if (!parsed.data || typeof parsed.data !== 'object') return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function loadSchema() {
      const raw = localStorage.getItem(STORAGE_KEYS.schema);
      if (!raw) return structuredClone(defaultSchema);
      try {
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed.tabs)) throw new Error('tabs missing');
        return parsed;
      } catch {
        return structuredClone(defaultSchema);
      }
    }

    function loadAdmin() {
      return localStorage.getItem(STORAGE_KEYS.admin) === 'true';
    }

    function saveAdmin(val) {
      localStorage.setItem(STORAGE_KEYS.admin, String(val));
    }

    function normalizeTableName(name) {
      return String(name || '').trim().toLowerCase();
    }

    function findRecordById(tableRows, recordId) {
      return (tableRows || []).find(row => row.recordId === recordId || row.id === recordId || row.fields?.recordId === recordId);
    }

    function findClientRecord(tableRows, clientId) {
      const needle = String(clientId || '').trim().toLowerCase();
      if (!needle) return (tableRows || [])[0] || null;
      return (tableRows || []).find(row => {
        const fields = row.fields || {};
        const candidates = [
          row.recordId,
          row.id,
          fields.recordId,
          fields.airtableId,
          fields['Client Record ID'],
          fields.clientId
        ];
        return candidates.some(v => String(v || '').trim().toLowerCase() === needle);
      }) || null;
    }

    function collectRecordIds(value) {
      if (value == null || value === '') return [];
      if (Array.isArray(value)) return value.flatMap(collectRecordIds);
      if (typeof value === 'object') return Object.values(value).flatMap(collectRecordIds);
      if (typeof value === 'string' && /^rec[a-z0-9]+$/i.test(value.trim())) return [value.trim()];
      return [];
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function renderValue(value) {
      if (value == null || value === '') return '<span class="muted">â€”</span>';
      if (Array.isArray(value)) {
        return value.map(v => `<span class="record-pill">${escapeHtml(v)}</span>`).join('');
      }
      if (typeof value === 'object') {
        return `<code>${escapeHtml(JSON.stringify(value))}</code>`;
      }
      return escapeHtml(value);
    }

    function renderHeader() {
      const record = state.clientRecord;
      const fields = record?.fields || {};
      const name = record
        ? (fields['Display Name'] || fields['display name'] || `${fields['Last Name'] || ''}, ${fields['First Name'] || ''}`.trim().replace(/^,\s*/, '') || record.recordId)
        : 'Client not found';

      document.getElementById('clientName').textContent = name;
      document.getElementById('clientMeta').innerHTML = `recordId: <strong>${escapeHtml(record?.recordId || state.clientId || '-')}</strong>`;

      const relatedRowsCount = state.clientRecord
        ? state.schema.tabs
            .flatMap(tab => tab.sections || [])
            .filter(section => section.type === 'related-list')
            .reduce((acc, section) => acc + resolveRelatedRows(section).length, 0)
        : 0;

      const summaryItems = [
        { label: 'Case Manager', value: fields['Case Manager'] || 'Unassigned' },
        { label: 'Entry Status', value: fields['Entry Status'] || 'Unknown' },
        { label: 'Current Stage', value: fields['Current Stage'] || 'Unknown' },
        { label: 'Related Rows', value: relatedRowsCount }
      ];

      document.getElementById('summaryRow').innerHTML = summaryItems
        .map(item => `<div class="summary-card"><div class="summary-label">${escapeHtml(item.label)}</div><div class="summary-value">${escapeHtml(item.value)}</div></div>`)
        .join('');
    }

    function renderTabs() {
      if (!state.activeTab) state.activeTab = state.schema.tabs[0]?.id;
      const html = state.schema.tabs.map(tab => {
        const cls = tab.id === state.activeTab ? 'tab active' : 'tab';
        return `<button class="${cls}" type="button" data-tab="${escapeHtml(tab.id)}">${escapeHtml(tab.label || tab.id)}</button>`;
      }).join('');
      const tabStrip = document.getElementById('tabStrip');
      tabStrip.innerHTML = html;
      tabStrip.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.activeTab = btn.dataset.tab;
          renderTabs();
          renderTabContent();
        });
      });
    }

    function resolveTableRows(tableId) {
      const keys = Object.keys(state.data);
      const direct = state.data[tableId];
      if (Array.isArray(direct)) return direct;
      const byNormalized = keys.find(key => normalizeTableName(key) === normalizeTableName(tableId));
      if (byNormalized) return state.data[byNormalized] || [];
      return [];
    }

    function resolveRelatedRows(section) {
      const rows = resolveTableRows(section.tableId);
      const allowedIds = new Set([state.clientId, state.clientRecord?.recordId].filter(Boolean));
      return rows.filter(row => {
        const fields = row.fields || {};
        const fkValues = (section.foreignKeys || ['Client', 'Client Record ID', 'clientId']).flatMap(key => collectRecordIds(fields[key]).concat(fields[key] || []));
        return fkValues.some(v => allowedIds.has(String(v).trim()));
      });
    }

    function buildCrossLinks(row) {
      const rowIdCandidates = collectRecordIds(row.fields).filter(id => id !== row.recordId);
      const links = [];
      for (const [tableName, tableRows] of Object.entries(state.data)) {
        if (!Array.isArray(tableRows)) continue;
        for (const candidate of rowIdCandidates) {
          const matched = findRecordById(tableRows, candidate);
          if (matched && matched !== row) links.push({ tableName, recordId: candidate });
        }
      }
      const deduped = [];
      const seen = new Set();
      for (const link of links) {
        const key = `${link.tableName}:${link.recordId}`;
        if (seen.has(key)) continue;
        seen.add(key);
        deduped.push(link);
      }
      return deduped;
    }

    function renderSection(section) {
      if (section.type === 'fields') {
        const row = state.clientRecord;
        const fieldsHtml = (section.fields || []).map(name => `<div class="kv"><div class="key">${escapeHtml(name)}</div><div>${renderValue(row?.fields?.[name])}</div></div>`).join('');
        return `<section class="panel"><h3>${escapeHtml(section.title || 'Section')}</h3><div class="panel-body">${fieldsHtml || '<span class="muted">No fields configured.</span>'}</div></section>`;
      }

      if (section.type === 'related-list') {
        const rows = resolveRelatedRows(section);
        const cards = rows.map(row => {
          const titleField = section.fields?.[0];
          const title = row.fields?.[titleField] || row.recordId;
          const fields = (section.fields || []).slice(1).map(name => `<div class="kv"><div class="key">${escapeHtml(name)}</div><div>${renderValue(row.fields?.[name])}</div></div>`).join('');
          const links = buildCrossLinks(row)
            .map(link => `<a href="?clientId=${encodeURIComponent(link.recordId)}" title="Open ${escapeHtml(link.recordId)}">${escapeHtml(link.tableName)}: ${escapeHtml(link.recordId)}</a>`)
            .join('');
          const fkPills = collectRecordIds(row.fields).map(id => `<span class="record-pill good">${escapeHtml(id)}</span>`).join('');
          return `<article class="card"><div class="card-head"><div class="card-title">${escapeHtml(title)}</div><span class="record-pill">${escapeHtml(row.recordId || '-')}</span></div>${fields}<div class="pill-group">${fkPills}</div><div class="links">${links || '<span class="muted">No linked records found.</span>'}</div></article>`;
        }).join('');

        return `<section class="panel"><h3>${escapeHtml(section.title || 'Related')}</h3><div class="panel-body"><div class="list">${cards || '<div class="muted">No related records found for this client recordId.</div>'}</div></div></section>`;
      }

      return `<section class="panel"><h3>${escapeHtml(section.title || 'Unknown section')}</h3><div class="panel-body muted">Unsupported section type: ${escapeHtml(section.type || '-')}</div></section>`;
    }

    function renderTabContent() {
      const tab = state.schema.tabs.find(t => t.id === state.activeTab) || state.schema.tabs[0];
      const html = (tab?.sections || []).map(renderSection).join('');
      const fallback = state.clientRecord
        ? '<div class="muted">No sections configured.</div>'
        : '<div class="muted">No client data found for this selection. Open the profile from the Clients page to load a scoped record context.</div>';
      document.getElementById('tabContent').innerHTML = `<div class="layout">${html || fallback}</div>`;
    }

    function renderSchemaEditor() {
      const drawer = document.getElementById('schemaDrawer');
      drawer.classList.toggle('open', state.admin && drawer.dataset.open === 'true');
      document.getElementById('schemaJson').value = JSON.stringify(state.schema, null, 2);
    }

    function render() {
      document.getElementById('adminToggle').textContent = `Admin: ${state.admin ? 'On' : 'Off'}`;
      renderHeader();
      renderTabs();
      renderTabContent();
      renderSchemaEditor();
    }

    async function loadData() {
      const contextSnapshot = getClientContextSnapshot();
      if (contextSnapshot) {
        state.data = contextSnapshot.data;
        const contextClients = resolveContextClients(state.data);
        state.clientRecord = findClientRecord(contextClients, state.clientId) || contextClients[0] || null;
        if (state.clientRecord?.recordId) state.clientId = state.clientRecord.recordId;
        return;
      }

      const canUseAmino = typeof AminoData !== 'undefined' && typeof AminoData.getTables === 'function';
      if (!canUseAmino) {
        state.data = { Clients: [] };
        state.clientRecord = null;
        return;
      }

      try {
        const tables = await AminoData.getTables();
        const byTableName = {};
        for (const table of tables) {
          const tableId = table.table_id || table.id;
          const tableName = table.table_name || table.name || tableId;
          const rows = await AminoData.getTableRecords(tableId);
          byTableName[tableName] = rows;
          byTableName[tableId] = rows;
        }

        state.data = byTableName;
        const clientTableMatch = Object.keys(byTableName).find(name => normalizeTableName(name) === 'clients')
          || Object.keys(byTableName).find(name => normalizeTableName(name) === 'client info')
          || 'Clients';
        const clients = byTableName[clientTableMatch] || [];
        state.clientRecord = findClientRecord(clients, state.clientId) || clients[0] || null;
        if (state.clientRecord?.recordId) state.clientId = state.clientRecord.recordId;
      } catch (err) {
        console.warn('Failed loading AminoData:', err);
        state.data = { Clients: [] };
        state.clientRecord = null;
      }
    }

    function resolveContextClients(data) {
      const byName = Object.keys(data || {}).find(name => normalizeTableName(name) === 'clients')
        || Object.keys(data || {}).find(name => normalizeTableName(name) === 'client info');
      if (byName) return data[byName] || [];
      return data?.Clients || [];
    }

    function wireEvents() {
      const schemaDrawer = document.getElementById('schemaDrawer');
      const schemaStatus = document.getElementById('schemaStatus');

      document.getElementById('adminToggle').addEventListener('click', () => {
        state.admin = !state.admin;
        saveAdmin(state.admin);
        if (!state.admin) schemaDrawer.dataset.open = 'false';
        schemaStatus.className = 'status';
        schemaStatus.textContent = '';
        render();
      });

      document.getElementById('schemaToggle').addEventListener('click', () => {
        if (!state.admin) {
          schemaStatus.className = 'status';
          schemaStatus.textContent = 'Enable Admin mode to edit schema.';
          return;
        }
        schemaDrawer.dataset.open = schemaDrawer.dataset.open === 'true' ? 'false' : 'true';
        renderSchemaEditor();
      });

      document.getElementById('saveSchema').addEventListener('click', () => {
        if (!state.admin) return;
        try {
          const parsed = JSON.parse(document.getElementById('schemaJson').value);
          if (!Array.isArray(parsed.tabs)) throw new Error('Schema must contain a tabs array.');
          state.schema = parsed;
          localStorage.setItem(STORAGE_KEYS.schema, JSON.stringify(parsed));
          if (!state.schema.tabs.find(t => t.id === state.activeTab)) state.activeTab = state.schema.tabs[0]?.id;
          schemaStatus.className = 'status success';
          schemaStatus.textContent = 'Schema saved.';
          render();
        } catch (err) {
          schemaStatus.className = 'status';
          schemaStatus.textContent = `Schema error: ${err.message}`;
        }
      });

      document.getElementById('resetSchema').addEventListener('click', () => {
        if (!state.admin) return;
        state.schema = structuredClone(defaultSchema);
        localStorage.removeItem(STORAGE_KEYS.schema);
        state.activeTab = state.schema.tabs[0]?.id;
        schemaStatus.className = 'status success';
        schemaStatus.textContent = 'Schema reset to defaults.';
        render();
      });
    }

    (async function init() {
      await loadData();
      wireEvents();
      render();
    })();
  </script>
</body>
</html>
